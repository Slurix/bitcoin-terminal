<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bitcoin Intelligence — Live Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:        #07090f;
  --surface:   #0d1117;
  --surface2:  #161b27;
  --surface3:  #1e2535;
  --border:    rgba(255,255,255,0.06);
  --border2:   rgba(255,255,255,0.1);

  --cyan:      #22d3ee;
  --cyan-dim:  rgba(34,211,238,0.12);
  --cyan-glow: rgba(34,211,238,0.25);

  --violet:    #a78bfa;
  --violet-dim:rgba(167,139,250,0.12);

  --gold:      #fbbf24;
  --gold-dim:  rgba(251,191,36,0.12);

  --green:     #4ade80;
  --green-dim: rgba(74,222,128,0.12);
  --red:       #fb7185;
  --red-dim:   rgba(251,113,133,0.12);

  --text:      #e2e8f0;
  --text2:     #94a3b8;
  --text3:     #475569;

  --r:         8px;
  --r2:        12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', -apple-system, sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Subtle bg noise */
body::after {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0; opacity: 0.4;
}

/* Ambient glow */
body::before {
  content: '';
  position: fixed;
  top: -200px; left: 50%; transform: translateX(-50%);
  width: 900px; height: 600px;
  background: radial-gradient(ellipse, rgba(34,211,238,0.04) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

.app { position: relative; z-index: 1; max-width: 1760px; margin: 0 auto; padding: 16px 20px; }

/* ── HEADER ──────────────────────────────────────── */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  margin-bottom: 12px;
}

.logo-mark {
  display: flex;
  align-items: center;
  gap: 12px;
}
.logo-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--cyan), var(--violet));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: #fff;
  flex-shrink: 0;
}
.logo-text {
  font-size: 15px; font-weight: 700; color: var(--text);
  letter-spacing: -0.3px;
}
.logo-sub {
  font-size: 11px; color: var(--text3); font-weight: 400;
  letter-spacing: 0.5px;
}

.header-center {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 100px;
  padding: 4px;
}
.h-tab {
  padding: 6px 18px;
  border-radius: 100px;
  font-size: 12px; font-weight: 500;
  color: var(--text3);
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}
.h-tab:hover { color: var(--text2); }
.h-tab.active {
  background: var(--surface3);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}

.header-right {
  display: flex; align-items: center; gap: 20px;
}
.live-pill {
  display: flex; align-items: center; gap: 6px;
  background: var(--green-dim);
  border: 1px solid rgba(74,222,128,0.2);
  border-radius: 100px;
  padding: 5px 12px;
  font-size: 11px; font-weight: 500; color: var(--green);
}
.live-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green);
  animation: livepulse 2s ease-in-out infinite;
}
@keyframes livepulse {
  0%,100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74,222,128,0.4); }
  50%      { opacity: 0.8; box-shadow: 0 0 0 4px rgba(74,222,128,0); }
}
#clock { font-family: 'JetBrains Mono'; font-size: 12px; color: var(--text3); }
#last-updated { font-size: 11px; color: var(--text3); }

/* ── PAGE SECTIONS ─────────────────────────────── */
.page { display: none; }
.page.active { display: block; }

/* ── TOP METRIC STRIP ─────────────────────────── */
.metric-strip {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  margin-bottom: 12px;
}
.mcard {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 14px 16px;
  transition: border-color 0.2s;
}
.mcard:hover { border-color: var(--border2); }
.mcard-label {
  font-size: 10px; font-weight: 500; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--text3); margin-bottom: 6px;
}
.mcard-value {
  font-family: 'JetBrains Mono'; font-size: 16px;
  font-weight: 500; color: var(--text);
}
.mcard-value.big {
  font-size: 20px; font-weight: 600;
  color: var(--cyan);
}
.mcard-sub { font-size: 11px; color: var(--text3); margin-top: 3px; }

/* ── MAIN LAYOUT ────────────────────────────────── */
.dashboard-layout {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 12px;
  align-items: start;
}

/* ── SIDEBAR ──────────────────────────────────── */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ── CARDS ──────────────────────────────────────── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 18px;
  transition: border-color 0.2s;
}
.card:hover { border-color: var(--border2); }

.card-title {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text3);
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.card-title .ct-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--cyan);
  box-shadow: 0 0 6px var(--cyan);
}

canvas { width: 100% !important; }

/* ── MAIN CHARTS AREA ──────────────────────────── */
.main-area {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chart-row-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.chart-row-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

/* ── FEAR & GREED ──────────────────────────────── */
.fg-arc-wrap {
  display: flex; flex-direction: column; align-items: center;
  padding: 8px 0 4px;
}
.fg-ring {
  position: relative;
  width: 120px; height: 60px;
  margin-bottom: 8px;
}
.fg-ring svg {
  position: absolute; top: 0; left: 0;
  width: 120px; height: 120px;
  transform: rotate(-180deg);
}
.fg-ring-val {
  position: absolute;
  bottom: -2px; left: 50%;
  transform: translateX(-50%);
  font-family: 'JetBrains Mono';
  font-size: 28px; font-weight: 600;
  color: var(--text);
}
#fg-label {
  font-size: 11px; font-weight: 600; letter-spacing: 1px;
  text-transform: uppercase; color: var(--text2);
  margin-top: 4px;
}
.fg-scale {
  display: flex; justify-content: space-between; width: 100%;
  font-size: 9px; color: var(--text3); margin-top: 8px;
  letter-spacing: 0.5px;
}

/* ── METRIC PAIRS ─────────────────────────────── */
.kv-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.kv-row:last-child { border-bottom: none; }
.kv-key { color: var(--text3); font-size: 11px; }
.kv-val { font-family: 'JetBrains Mono'; font-size: 12px; color: var(--text); font-weight: 500; }

/* ── HALVING ──────────────────────────────────── */
.hc-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
  margin: 10px 0;
}
.hc-box {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 10px;
  text-align: center;
}
.hc-num {
  font-family: 'JetBrains Mono';
  font-size: 24px; font-weight: 600;
  color: var(--violet);
}
.hc-lbl {
  font-size: 9px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text3); margin-top: 2px;
}

/* ── FEE TIERS ────────────────────────────────── */
.fee-tier {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 0;
  border-bottom: 1px solid var(--border);
}
.fee-tier:last-child { border-bottom: none; }
.fee-label { font-size: 11px; color: var(--text3); }
.fee-pill {
  font-family: 'JetBrains Mono';
  font-size: 11px; font-weight: 500;
  padding: 3px 10px; border-radius: 100px;
}
.fp-fast { background: var(--red-dim); color: var(--red); }
.fp-mid  { background: var(--gold-dim); color: var(--gold); }
.fp-slow { background: var(--green-dim); color: var(--green); }
.fp-min  { background: var(--surface2); color: var(--text3); }
.fee-est { font-size: 10px; color: var(--text3); }

/* ── SUPPLY PROGRESS ──────────────────────────── */
.supply-track {
  height: 8px;
  background: var(--surface2);
  border-radius: 100px;
  overflow: hidden;
  margin: 10px 0 6px;
}
.supply-fill {
  height: 100%;
  border-radius: 100px;
  background: linear-gradient(90deg, var(--violet), var(--cyan));
  transition: width 1.5s ease;
}
.supply-meta {
  display: flex; justify-content: space-between;
  font-size: 10px; color: var(--text3);
}

/* ── SUPPLY STAT GRID ─────────────────────────── */
.supply-stat-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 12px;
}
.ssg-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 10px 12px;
}
.ssg-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text3); margin-bottom: 4px; }
.ssg-value { font-family: 'JetBrains Mono'; font-size: 13px; font-weight: 500; color: var(--text); }
.ssg-sub   { font-size: 9px; color: var(--text3); margin-top: 2px; }

/* ── DOMINANCE BAR CHART ─────────────────────── */
/* handled by chartjs */

/* ── GLOBAL TABLE ─────────────────────────────── */
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--text3);
  padding: 8px 12px; text-align: left;
  border-bottom: 1px solid var(--border);
}
.data-table td {
  font-size: 12px; padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  font-family: 'JetBrains Mono'; font-weight: 400;
  color: var(--text2);
}
.data-table tr:hover td { background: rgba(255,255,255,0.02); }
.data-table td:first-child { color: var(--text3); font-size: 11px; }
.asset-symbol { font-weight: 600; color: var(--cyan); font-size: 11px; }

/* ── LOADING ──────────────────────────────────── */
.loading {
  display: flex; align-items: center; justify-content: center;
  height: 80px; color: var(--text3); font-size: 11px;
  letter-spacing: 1px; font-weight: 500;
}
.loading::before {
  content: '';
  width: 16px; height: 16px;
  border: 2px solid var(--border2);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── FLASH ANIMATIONS ─────────────────────────── */
.flash-up { animation: fup 0.6s ease-out; }
.flash-dn { animation: fdn 0.6s ease-out; }
@keyframes fup { 0% { color: var(--green); } 100% { } }
@keyframes fdn { 0% { color: var(--red);   } 100% { } }

/* ── TICKER ──────────────────────────────────── */
.ticker-wrap {
  overflow: hidden;
  border-top: 1px solid var(--border);
  margin-top: 12px; padding: 10px 0;
  background: var(--surface);
  border-radius: var(--r);
}
.ticker {
  display: flex; gap: 48px;
  animation: ticker-scroll 30s linear infinite;
  white-space: nowrap;
}
@keyframes ticker-scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
.ticker-item { font-size: 11px; color: var(--text3); font-weight: 500; }
.ticker-item span { color: var(--cyan); margin-left: 6px; font-family: 'JetBrains Mono'; }

/* ── BLOCKS PAGE ─────────────────────────────── */
.bstats-strip {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  margin-bottom: 12px;
}
.bscard {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px;
  text-align: center;
  transition: border-color 0.2s;
}
.bscard:hover { border-color: var(--border2); }
.bsc-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text3); margin-bottom: 8px; }
.bsc-value { font-family: 'JetBrains Mono'; font-size: 17px; font-weight: 600; color: var(--cyan); }
.bsc-sub   { font-size: 10px; color: var(--text3); margin-top: 4px; }

/* Blocks table */
.blocks-explorer-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.btable { width: 100%; border-collapse: collapse; }
.btable th {
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--text3);
  padding: 8px 14px; text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.btable td {
  font-size: 11px; padding: 10px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.025);
  font-family: 'JetBrains Mono';
  color: var(--text2); white-space: nowrap;
}
.btable tr:hover td { background: rgba(34,211,238,0.02); cursor: pointer; }

.pool-badge {
  display: inline-block; padding: 2px 8px;
  font-size: 10px; font-weight: 500;
  background: var(--violet-dim);
  border: 1px solid rgba(167,139,250,0.2);
  border-radius: 4px; color: var(--violet);
  font-family: 'Inter', sans-serif;
}
.size-bar-wrap { display: flex; align-items: center; gap: 8px; }
.size-bar {
  height: 4px; border-radius: 100px;
  background: linear-gradient(90deg, var(--violet), var(--cyan));
  min-width: 2px;
}
.b-hash { color: var(--text3); font-size: 10px; }
.block-age { color: var(--text3); font-size: 10px; }
.fee-bar-mini { display: flex; height: 3px; border-radius: 2px; overflow: hidden; gap: 1px; min-width: 80px; }
.fee-segment { height: 100%; border-radius: 1px; }

/* ── RESPONSIVE ──────────────────────────────── */
@media (max-width: 1200px) {
  .dashboard-layout { grid-template-columns: 1fr; }
  .sidebar { display: grid; grid-template-columns: 1fr 1fr; }
  .metric-strip { grid-template-columns: repeat(3, 1fr); }
  .bstats-strip { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 768px) {
  .chart-row-3, .chart-row-2 { grid-template-columns: 1fr; }
  .metric-strip { grid-template-columns: repeat(2, 1fr); }
  .sidebar { grid-template-columns: 1fr; }
  .supply-stat-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>
<div class="app">

  <!-- ── HEADER ───────────────────────────────────── -->
  <header>
    <div class="logo-mark">
      <div class="logo-icon">₿</div>
      <div>
        <div class="logo-text">Bitcoin Intelligence</div>
        <div class="logo-sub">Live Market Dashboard</div>
      </div>
    </div>

    <div class="header-center">
      <button class="h-tab active" onclick="switchTab('dashboard', this)">Dashboard</button>
      <button class="h-tab" onclick="switchTab('blocks', this)">Latest Blocks</button>
    </div>

    <div class="header-right">
      <div class="live-pill"><div class="live-dot"></div>Live</div>
      <div id="clock">--:--:-- UTC</div>
      <div id="last-updated">Updating...</div>
    </div>
  </header>

  <!-- ══════════════════════════════════════════════ -->
  <!--  DASHBOARD PAGE                               -->
  <!-- ══════════════════════════════════════════════ -->
  <div class="page active" id="page-dashboard">

    <!-- METRIC STRIP -->
    <div class="metric-strip">
      <div class="mcard">
        <div class="mcard-label">BTC Price</div>
        <div class="mcard-value big" id="big-price">$—</div>
        <div class="mcard-sub" id="price-change" style="color:var(--text3);">±0.00%</div>
      </div>
      <div class="mcard">
        <div class="mcard-label">24h Change</div>
        <div class="mcard-value" id="price-change-abs" style="font-size:15px;">—</div>
        <div class="mcard-sub">H: <span id="price-high">—</span> · L: <span id="price-low">—</span></div>
      </div>
      <div class="mcard">
        <div class="mcard-label">Market Cap</div>
        <div class="mcard-value" style="font-size:15px;" id="mkt-cap">—</div>
        <div class="mcard-sub">Rank <span id="mkt-rank">—</span></div>
      </div>
      <div class="mcard">
        <div class="mcard-label">24h Volume</div>
        <div class="mcard-value" style="font-size:15px;" id="volume">—</div>
        <div class="mcard-sub">USD traded</div>
      </div>
      <div class="mcard">
        <div class="mcard-label">BTC Dominance</div>
        <div class="mcard-value" style="font-size:15px;" id="dominance">—</div>
        <div class="mcard-sub">of total market</div>
      </div>
      <div class="mcard">
        <div class="mcard-label">All Time High</div>
        <div class="mcard-value" style="font-size:15px;" id="ath-metric">—</div>
        <div class="mcard-sub" id="ath-date">—</div>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="dashboard-layout">

      <!-- MAIN CONTENT -->
      <div class="main-area">

        <!-- Price Chart -->
        <div class="card">
          <div class="card-title">
            <span class="ct-dot"></span>
            Price History · 3 Months
            <span style="margin-left:auto;font-size:10px;color:var(--text3);font-weight:400;">BTC / USD</span>
          </div>
          <canvas id="priceChart" height="200"></canvas>
        </div>

        <!-- Row: OHLC + Volume + Market Cap -->
        <div class="chart-row-3">
          <div class="card">
            <div class="card-title"><span class="ct-dot" style="background:var(--gold);box-shadow:0 0 6px var(--gold);"></span>OHLC Price Action</div>
            <canvas id="ohlcChart" height="150"></canvas>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-dot" style="background:var(--violet);box-shadow:0 0 6px var(--violet);"></span>Trading Volume · 3M</div>
            <canvas id="volumeChart" height="150"></canvas>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-dot" style="background:var(--green);box-shadow:0 0 6px var(--green);"></span>Market Cap · 3M</div>
            <canvas id="mcapChart" height="150"></canvas>
          </div>
        </div>

        <!-- Row: MA + RSI -->
        <div class="chart-row-2">
          <div class="card">
            <div class="card-title"><span class="ct-dot"></span>Moving Averages · 3M</div>
            <canvas id="maChart" height="150"></canvas>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-dot" style="background:var(--gold);box-shadow:0 0 6px var(--gold);"></span>RSI Indicator · 14-Day</div>
            <canvas id="rsiChart" height="130"></canvas>
            <div style="display:flex;gap:16px;margin-top:8px;">
              <span style="font-size:10px;color:var(--text3);">— <span style="color:var(--red)">Overbought 70</span></span>
              <span style="font-size:10px;color:var(--text3);">— <span style="color:var(--green)">Oversold 30</span></span>
              <span style="font-size:10px;color:var(--text3);">— <span style="color:var(--gold)">RSI</span></span>
            </div>
          </div>
        </div>

        <!-- Row: Bollinger + Returns + Dominance -->
        <div class="chart-row-3">
          <div class="card">
            <div class="card-title"><span class="ct-dot"></span>Bollinger Bands · 20D</div>
            <canvas id="bollingerChart" height="150"></canvas>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-dot" style="background:var(--violet);box-shadow:0 0 6px var(--violet);"></span>Returns Distribution</div>
            <canvas id="returnsChart" height="150"></canvas>
          </div>
          <div class="card">
            <div class="card-title"><span class="ct-dot" style="background:var(--cyan);box-shadow:0 0 6px var(--cyan);"></span>Market Dominance</div>
            <canvas id="dominanceChart" height="150"></canvas>
          </div>
        </div>

        <!-- Supply + Stats -->
        <div class="card">
          <div class="card-title"><span class="ct-dot" style="background:var(--violet);box-shadow:0 0 6px var(--violet);"></span>Bitcoin Supply</div>
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
            <div style="font-size:11px;color:var(--text3);">Mined</div>
            <div class="supply-track" style="flex:1;margin:0;">
              <div class="supply-fill" id="supply-bar" style="width:0%"></div>
            </div>
            <div id="supply-pct-label" style="font-size:11px;color:var(--cyan);font-family:'JetBrains Mono';white-space:nowrap;">— %</div>
            <div style="font-size:11px;color:var(--text3);">21M cap</div>
          </div>
          <div class="supply-stat-grid">
            <div class="ssg-card">
              <div class="ssg-label">Circulating</div>
              <div class="ssg-value" id="supply-mined">—</div>
              <div class="ssg-sub">BTC mined</div>
            </div>
            <div class="ssg-card">
              <div class="ssg-label">Remaining</div>
              <div class="ssg-value" style="color:var(--text3);" id="supply-left">—</div>
              <div class="ssg-sub">to be mined</div>
            </div>
            <div class="ssg-card">
              <div class="ssg-label">Max Supply</div>
              <div class="ssg-value">21.000M</div>
              <div class="ssg-sub">hard cap</div>
            </div>
            <div class="ssg-card">
              <div class="ssg-label">Block Reward</div>
              <div class="ssg-value">3.125</div>
              <div class="ssg-sub">BTC / block</div>
            </div>
            <div class="ssg-card">
              <div class="ssg-label">Market Cap</div>
              <div class="ssg-value" id="supply-mcap">—</div>
              <div class="ssg-sub">USD</div>
            </div>
            <div class="ssg-card">
              <div class="ssg-label">24h Volume</div>
              <div class="ssg-value" id="supply-vol">—</div>
              <div class="ssg-sub">USD traded</div>
            </div>
          </div>
        </div>

        <!-- Global Table -->
        <div class="card">
          <div class="card-title"><span class="ct-dot"></span>Global Crypto Market</div>
          <table class="data-table" id="global-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Asset</th>
                <th>Price</th>
                <th>24h %</th>
                <th>7d %</th>
                <th>Market Cap</th>
                <th>Volume 24h</th>
                <th>Dominance</th>
              </tr>
            </thead>
            <tbody id="global-tbody">
              <tr><td colspan="8" class="loading" style="height:60px;"></td></tr>
            </tbody>
          </table>
        </div>

      </div><!-- /main-area -->

      <!-- SIDEBAR -->
      <div class="sidebar">

        <!-- Fear & Greed -->
        <div class="card">
          <div class="card-title"><span class="ct-dot" style="background:var(--gold);box-shadow:0 0 6px var(--gold);"></span>Fear & Greed</div>
          <div class="fg-arc-wrap">
            <div class="fg-ring">
              <svg viewBox="0 0 120 120">
                <!-- bg arc -->
                <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="12"
                  stroke-dasharray="157 157" stroke-dashoffset="0" stroke-linecap="round"/>
                <!-- value arc -->
                <circle cx="60" cy="60" r="50" fill="none" stroke="var(--cyan)" stroke-width="12"
                  stroke-dasharray="157 157" stroke-dashoffset="157" stroke-linecap="round"
                  id="fg-arc" style="transition: stroke-dashoffset 1s ease, stroke 1s ease;"/>
              </svg>
              <div class="fg-ring-val" id="fg-value">—</div>
            </div>
            <div id="fg-label">Loading</div>
            <div class="fg-scale">
              <span>Fear</span><span>Neutral</span><span>Greed</span>
            </div>
          </div>
        </div>

        <!-- Market Metrics -->
        <div class="card">
          <div class="card-title"><span class="ct-dot"></span>Market Metrics</div>
          <div class="kv-row">
            <span class="kv-key">7D Change</span>
            <span class="kv-val" id="change7d">—</span>
          </div>
          <div class="kv-row">
            <span class="kv-key">30D Change</span>
            <span class="kv-val" id="change30d">—</span>
          </div>
          <div class="kv-row">
            <span class="kv-key">Circulating</span>
            <span class="kv-val" id="circulating">—</span>
          </div>
          <div class="kv-row">
            <span class="kv-key">ATH</span>
            <span class="kv-val" id="price-ath">—</span>
          </div>
        </div>

        <!-- Halving Countdown -->
        <div class="card">
          <div class="card-title"><span class="ct-dot" style="background:var(--violet);box-shadow:0 0 6px var(--violet);"></span>Next Halving</div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">Est. Date: <span id="halving-date" style="color:var(--text2);">—</span></div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">Block: <span id="halving-block" style="color:var(--text2);">—</span></div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:10px;">Remaining: <span id="halving-blocks-left" style="color:var(--cyan);">—</span></div>
          <div class="hc-grid">
            <div class="hc-box"><div class="hc-num" id="hc-days">—</div><div class="hc-lbl">Days</div></div>
            <div class="hc-box"><div class="hc-num" id="hc-hours">—</div><div class="hc-lbl">Hrs</div></div>
            <div class="hc-box"><div class="hc-num" id="hc-mins">—</div><div class="hc-lbl">Min</div></div>
            <div class="hc-box"><div class="hc-num" id="hc-secs">—</div><div class="hc-lbl">Sec</div></div>
          </div>
          <div style="font-size:10px;color:var(--text3);margin-top:8px;">Reward: <span style="color:var(--gold)">3.125 BTC</span> → <span style="color:var(--text3)">1.5625 BTC</span></div>
        </div>

        <!-- Mempool & Fees -->
        <div class="card">
          <div class="card-title"><span class="ct-dot" style="background:var(--green);box-shadow:0 0 6px var(--green);"></span>Mempool & Fees</div>
          <div id="mempool-content"><div class="loading" style="height:60px;"></div></div>
        </div>

      </div><!-- /sidebar -->
    </div><!-- /dashboard-layout -->

    <!-- TICKER -->
    <div class="ticker-wrap">
      <div class="ticker" id="ticker">
        <div class="ticker-item">BTC/USD<span id="t-price">$—</span></div>
        <div class="ticker-item">24H CHG<span id="t-change">—</span></div>
        <div class="ticker-item">MARKET CAP<span id="t-mcap">—</span></div>
        <div class="ticker-item">VOLUME<span id="t-vol">—</span></div>
        <div class="ticker-item">DOMINANCE<span id="t-dom">—</span></div>
        <div class="ticker-item">BLOCK HEIGHT<span id="t-block">—</span></div>
        <div class="ticker-item">MEMPOOL TXS<span id="t-mempool">—</span></div>
        <div class="ticker-item">NEXT HALVING<span id="t-halving">—</span></div>
        <div class="ticker-item">BTC/USD<span id="t-price2">$—</span></div>
        <div class="ticker-item">24H CHG<span id="t-change2">—</span></div>
        <div class="ticker-item">MARKET CAP<span id="t-mcap2">—</span></div>
        <div class="ticker-item">VOLUME<span id="t-vol2">—</span></div>
        <div class="ticker-item">DOMINANCE<span id="t-dom2">—</span></div>
        <div class="ticker-item">BLOCK HEIGHT<span id="t-block2">—</span></div>
        <div class="ticker-item">MEMPOOL TXS<span id="t-mempool2">—</span></div>
        <div class="ticker-item">NEXT HALVING<span id="t-halving2">—</span></div>
      </div>
    </div>

  </div><!-- /page-dashboard -->

  <!-- ══════════════════════════════════════════════ -->
  <!--  BLOCKS PAGE                                  -->
  <!-- ══════════════════════════════════════════════ -->
  <div class="page" id="page-blocks">

    <div class="bstats-strip">
      <div class="bscard">
        <div class="bsc-label">Block Height</div>
        <div class="bsc-value" id="bp-height">—</div>
        <div class="bsc-sub">chain tip</div>
      </div>
      <div class="bscard">
        <div class="bsc-label">Avg Block Size</div>
        <div class="bsc-value" id="bp-avg-size">—</div>
        <div class="bsc-sub">last 15 blocks</div>
      </div>
      <div class="bscard">
        <div class="bsc-label">Avg Tx Count</div>
        <div class="bsc-value" id="bp-avg-txs">—</div>
        <div class="bsc-sub">per block</div>
      </div>
      <div class="bscard">
        <div class="bsc-label">Avg Total Fees</div>
        <div class="bsc-value" id="bp-avg-fees">—</div>
        <div class="bsc-sub">BTC / block</div>
      </div>
      <div class="bscard">
        <div class="bsc-label">Avg Median Fee</div>
        <div class="bsc-value" id="bp-avg-median-fee">—</div>
        <div class="bsc-sub">sat/vByte</div>
      </div>
      <div class="bscard">
        <div class="bsc-label">Avg Block Time</div>
        <div class="bsc-value" id="bp-avg-time">—</div>
        <div class="bsc-sub">min (target: 10)</div>
      </div>
    </div>

    <div class="card">
      <div class="blocks-explorer-header">
        <div class="card-title" style="margin-bottom:0;"><span class="ct-dot"></span>Block Explorer</div>
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:10px;color:var(--text3);" id="blocks-last-updated">—</span>
          <div class="live-pill"><div class="live-dot"></div>Auto-refresh</div>
        </div>
      </div>
      <div style="overflow-x:auto;">
        <table class="btable" id="blocks-full-table">
          <thead>
            <tr>
              <th>Height</th>
              <th>Timestamp</th>
              <th>Age</th>
              <th>Miner / Pool</th>
              <th>Txs</th>
              <th>Size</th>
              <th>Weight</th>
              <th>Total Fees</th>
              <th>Median Fee</th>
              <th>Fee Range</th>
              <th>Block Hash</th>
            </tr>
          </thead>
          <tbody id="blocks-full-tbody">
            <tr><td colspan="11" class="loading" style="height:80px;"></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /page-blocks -->

</div><!-- /app -->

<script>
// ═══════════════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════════════
const fmt = {
  price:   v => v != null ? '$' + Number(v).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}) : '—',
  compact: v => { if (!v) return '—'; if (v >= 1e12) return '$' + (v/1e12).toFixed(2) + 'T'; if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'B'; if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'M'; return '$' + v.toLocaleString(); },
  pct:     v => v != null ? (v >= 0 ? '+' : '') + v.toFixed(2) + '%' : '—',
  number:  v => v != null ? Number(v).toLocaleString() : '—',
};

function setText(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }
function setColor(el, val) { if (!el) return; el.style.color = val > 0 ? 'var(--green)' : val < 0 ? 'var(--red)' : 'var(--text3)'; }

// Clock
setInterval(() => { setText('clock', new Date().toUTCString().slice(17, 25) + ' UTC'); }, 1000);
setText('clock', new Date().toUTCString().slice(17, 25) + ' UTC');

// Chart.js defaults
Chart.defaults.color = '#475569';
Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
Chart.defaults.font.family = "'JetBrains Mono', monospace";
Chart.defaults.font.size = 10;

const CYAN    = 'rgba(34,211,238,1)';
const CYAN_F  = 'rgba(34,211,238,0.12)';
const VIOLET  = 'rgba(167,139,250,1)';
const VIOLET_F= 'rgba(167,139,250,0.12)';
const GREEN   = 'rgba(74,222,128,1)';
const GREEN_F = 'rgba(74,222,128,0.12)';
const RED     = 'rgba(251,113,133,1)';
const RED_F   = 'rgba(251,113,133,0.12)';
const GOLD    = 'rgba(251,191,36,1)';
const GOLD_F  = 'rgba(251,191,36,0.1)';

const charts = {};
function makeChart(id, config) {
  const ctx = document.getElementById(id)?.getContext('2d');
  if (!ctx) return null;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, config);
  return charts[id];
}

const tooltipDefaults = {
  backgroundColor: 'rgba(13,17,23,0.95)',
  borderColor: 'rgba(255,255,255,0.08)',
  borderWidth: 1,
  titleColor: '#94a3b8',
  bodyColor: '#e2e8f0',
  padding: 10,
  cornerRadius: 8,
};

// ═══════════════════════════════════════════════════
// TAB SWITCHING
// ═══════════════════════════════════════════════════
function switchTab(tab, btn) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.h-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  btn.classList.add('active');
  if (tab === 'blocks') fetchBlocksFull();
}

// ═══════════════════════════════════════════════════
// PRICE CHART — cached, error-handled, locked to 3M
// ═══════════════════════════════════════════════════
const priceChartCache = {};
let activeDays = 90;
let priceChartLoading = false;

async function loadPriceChart(days) {
  if (priceChartLoading) return;
  activeDays = days;
  const canvas = document.getElementById('priceChart');
  if (canvas) canvas.style.opacity = '0.3';
  const cacheKey = String(days);
  const now = Date.now();
  if (priceChartCache[cacheKey] && (now - priceChartCache[cacheKey].ts) < 300000) {
    renderPriceChart(priceChartCache[cacheKey].data, days);
    if (canvas) canvas.style.opacity = '1';
    return;
  }
  priceChartLoading = true;
  try {
    const url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${days}${days !== 'max' && days <= 90 ? '&interval=daily' : ''}`;
    const res = await fetch(url);
    if (res.status === 429) { showChartError('priceChart', 'Rate limited — wait 60s'); if (canvas) canvas.style.opacity='1'; priceChartLoading=false; return; }
    if (!res.ok)             { showChartError('priceChart', 'API error ' + res.status);  if (canvas) canvas.style.opacity='1'; priceChartLoading=false; return; }
    const data = await res.json();
    if (!data.prices?.length) { showChartError('priceChart', 'No data'); if (canvas) canvas.style.opacity='1'; priceChartLoading=false; return; }
    priceChartCache[cacheKey] = { data, ts: now };
    renderPriceChart(data, days);
    if (canvas) canvas.style.opacity = '1';
  } catch(e) { showChartError('priceChart', 'Connection error'); if (canvas) canvas.style.opacity='1'; }
  priceChartLoading = false;
}

function showChartError(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  const ctx = el.getContext('2d');
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
  ctx.clearRect(0, 0, el.width, el.height);
  ctx.fillStyle = 'rgba(251,113,133,0.7)';
  ctx.font = "12px 'Inter', sans-serif";
  ctx.textAlign = 'center';
  ctx.fillText('⚠ ' + msg, el.width / 2, el.height / 2);
}

function renderPriceChart(data, days) {
  const labels = data.prices.map(p => {
    const d = new Date(p[0]);
    return days <= 1 ? d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
         : days <= 30 ? d.toLocaleDateString([], {month:'short',day:'numeric'})
         : d.toLocaleDateString([], {month:'short',year:'2-digit'});
  });
  const prices = data.prices.map(p => p[1]);
  const volumes = data.total_volumes?.map(v => v[1]) || [];
  const mcaps = data.market_caps?.map(m => m[1]) || [];
  const step = Math.max(1, Math.floor(labels.length / 300));
  const sl = arr => arr.filter((_,i) => i % step === 0);

  const pCtx = document.getElementById('priceChart')?.getContext('2d');
  if (!pCtx) return;
  const grad = pCtx.createLinearGradient(0, 0, 0, 380);
  grad.addColorStop(0, 'rgba(34,211,238,0.18)');
  grad.addColorStop(1, 'rgba(34,211,238,0.0)');

  makeChart('priceChart', {
    type: 'line',
    data: {
      labels: sl(labels),
      datasets: [{ label:'BTC', data:sl(prices), borderColor:CYAN, borderWidth:2, backgroundColor:grad, fill:true, tension:0.4, pointRadius:0, pointHoverRadius:5 }]
    },
    options: {
      responsive:true,
      interaction: { mode:'index', intersect:false },
      plugins: { legend:{display:false}, tooltip: { ...tooltipDefaults, callbacks: { label: c => '  ' + fmt.price(c.parsed.y) } } },
      scales: {
        x: { ticks:{ maxTicksLimit:8 }, grid:{display:false} },
        y: { ticks:{ callback: v => '$'+(v>=1000?(v/1000).toFixed(0)+'k':v) }, grid:{ color:'rgba(255,255,255,0.04)' } }
      }
    }
  });

  if (volumes.length) {
    makeChart('volumeChart', {
      type:'bar',
      data: { labels:sl(labels), datasets:[{ label:'Volume', data:sl(volumes), backgroundColor:'rgba(167,139,250,0.35)', borderColor:VIOLET, borderWidth:1, borderRadius:2 }] },
      options: { responsive:true, plugins:{ legend:{display:false}, tooltip:{...tooltipDefaults, callbacks:{label:c=>fmt.compact(c.parsed.y)}} }, scales:{ x:{ticks:{maxTicksLimit:6},grid:{display:false}}, y:{ticks:{callback:v=>fmt.compact(v).replace('$','')},grid:{color:'rgba(255,255,255,0.04)'}} } }
    });
  }

  if (mcaps.length) {
    const mcCtx = document.getElementById('mcapChart')?.getContext('2d');
    if (mcCtx) {
      const g = mcCtx.createLinearGradient(0,0,0,280);
      g.addColorStop(0,'rgba(74,222,128,0.15)'); g.addColorStop(1,'rgba(74,222,128,0)');
      makeChart('mcapChart', {
        type:'line',
        data:{ labels:sl(labels), datasets:[{ label:'MCap', data:sl(mcaps), borderColor:GREEN, borderWidth:1.5, backgroundColor:g, fill:true, tension:0.4, pointRadius:0 }] },
        options:{ responsive:true, plugins:{legend:{display:false},tooltip:{...tooltipDefaults,callbacks:{label:c=>fmt.compact(c.parsed.y)}}}, scales:{ x:{ticks:{maxTicksLimit:6},grid:{display:false}}, y:{ticks:{callback:v=>'$'+(v/1e9).toFixed(0)+'B'},grid:{color:'rgba(255,255,255,0.04)'}} } }
      });
    }
  }
  buildAdvancedCharts(prices, labels);
}

// ═══════════════════════════════════════════════════
// ADVANCED CHARTS
// ═══════════════════════════════════════════════════
function buildAdvancedCharts(prices, labels) {
  // OHLC — group into ~20 bars
  const dailyMap = {};
  const cached = priceChartCache['90'];
  const rawPrices = cached?.data?.prices;
  if (rawPrices?.length) {
    rawPrices.forEach(([ts, price]) => {
      const key = new Date(ts).toLocaleDateString('en-US', {month:'short',day:'numeric'});
      if (!dailyMap[key]) dailyMap[key] = [];
      dailyMap[key].push(price);
    });
  } else {
    const sz = Math.max(1, Math.floor(prices.length/90));
    for (let i=0;i<prices.length;i+=sz) { const k=labels[i]||String(i); dailyMap[k]=prices.slice(i,i+sz); }
  }
  const ohlcL=[],opens=[],highs=[],lows=[],closes=[];
  const allDays = Object.entries(dailyMap);
  const gs = Math.max(1, Math.ceil(allDays.length/20));
  for (let g=0;g<allDays.length;g+=gs) {
    const chunk = allDays.slice(g,g+gs);
    const pts = chunk.flatMap(([,p])=>p);
    if (!pts.length) continue;
    ohlcL.push(chunk[0][0]); opens.push(pts[0]); closes.push(pts[pts.length-1]);
    highs.push(Math.max(...pts)); lows.push(Math.min(...pts));
  }
  if (ohlcL.length) {
    const upColor   = closes.map((c,i) => c>=opens[i] ? 'rgba(74,222,128,0.75)' : 'rgba(251,113,133,0.75)');
    const upBorder  = closes.map((c,i) => c>=opens[i] ? GREEN : RED);
    const minLow = Math.min(...lows), maxHigh = Math.max(...highs);
    const pad = (maxHigh-minLow)*0.04;
    makeChart('ohlcChart', {
      type:'bar',
      data:{ labels:ohlcL, datasets:[
        { label:'Low', data:lows, backgroundColor:'transparent', borderColor:'transparent', stack:'o' },
        { label:'Body', data:closes.map((c,i)=>Math.abs(c-opens[i])), backgroundColor:upColor, borderColor:upBorder, borderWidth:1, stack:'o' }
      ]},
      options:{ responsive:true,
        plugins:{ legend:{display:false}, tooltip:{ ...tooltipDefaults, callbacks:{ title:items=>ohlcL[items[0].dataIndex], label:(c)=>{ const i=c.dataIndex; const chg=((closes[i]-opens[i])/opens[i]*100).toFixed(2); return [`O: ${fmt.price(opens[i])}`,`H: ${fmt.price(highs[i])}`,`L: ${fmt.price(lows[i])}`,`C: ${fmt.price(closes[i])}`,`Chg: ${closes[i]>=opens[i]?'+':''}${chg}%`]; } } } },
        scales:{
          x:{ stacked:true, ticks:{maxTicksLimit:8,font:{size:9}}, grid:{display:false} },
          y:{ stacked:true, min:Math.floor(minLow-pad), max:Math.ceil(maxHigh+pad), ticks:{callback:v=>'$'+(v>=1000?(v/1000).toFixed(0)+'k':v),maxTicksLimit:5}, grid:{color:'rgba(255,255,255,0.04)'} }
        }
      }
    });
  }

  // Moving Averages
  if (prices.length >= 20) {
    const maL = labels.slice(19); const ma7=[], ma20=[];
    for (let i=19;i<prices.length;i++) {
      ma7.push(prices.slice(Math.max(0,i-6),i+1).reduce((a,b)=>a+b)/Math.min(7,i+1));
      ma20.push(prices.slice(i-19,i+1).reduce((a,b)=>a+b)/20);
    }
    const maCtx = document.getElementById('maChart')?.getContext('2d');
    if (maCtx) {
      const mg = maCtx.createLinearGradient(0,0,0,280);
      mg.addColorStop(0,'rgba(34,211,238,0.1)'); mg.addColorStop(1,'rgba(34,211,238,0)');
      const f = Math.max(1,Math.floor(maL.length/20));
      makeChart('maChart',{
        type:'line',
        data:{ labels:maL.filter((_,i)=>i%f===0), datasets:[
          { label:'Price', data:prices.slice(19).filter((_,i)=>i%f===0), borderColor:'rgba(34,211,238,0.3)', borderWidth:1, pointRadius:0, tension:0.4, backgroundColor:mg, fill:true },
          { label:'MA7',   data:ma7.filter((_,i)=>i%f===0),  borderColor:CYAN,   borderWidth:1.5, pointRadius:0, tension:0.4, fill:false },
          { label:'MA20',  data:ma20.filter((_,i)=>i%f===0), borderColor:VIOLET, borderWidth:1.5, pointRadius:0, tension:0.4, fill:false },
        ]},
        options:{ responsive:true, plugins:{ legend:{display:true,labels:{boxWidth:8,padding:10,color:'#475569',font:{size:9}}}, tooltip:{...tooltipDefaults} }, scales:{ x:{ticks:{maxTicksLimit:6},grid:{display:false}}, y:{ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'rgba(255,255,255,0.04)'}} } }
      });
    }
  }

  // RSI
  if (prices.length >= 15) {
    const rsiV=[], rsiL=[];
    for (let i=14;i<prices.length;i++) {
      const ch=prices.slice(i-14,i+1).map((v,j,a)=>j>0?v-a[j-1]:0).slice(1);
      const ag=ch.filter(c=>c>0).reduce((a,b)=>a+b,0)/14;
      const al=ch.filter(c=>c<0).map(Math.abs).reduce((a,b)=>a+b,0)/14;
      rsiV.push(100-(100/(1+(al===0?100:ag/al)))); rsiL.push(labels[i]);
    }
    const f=Math.max(1,Math.floor(rsiV.length/30));
    makeChart('rsiChart',{
      type:'line',
      data:{ labels:rsiL.filter((_,i)=>i%f===0), datasets:[
        { label:'RSI', data:rsiV.filter((_,i)=>i%f===0), borderColor:GOLD, borderWidth:1.5, pointRadius:0, tension:0.3, fill:false },
        { label:'OB',  data:Array(Math.ceil(rsiV.length/f)).fill(70), borderColor:'rgba(251,113,133,0.4)', borderWidth:1, borderDash:[4,4], pointRadius:0, fill:false },
        { label:'OS',  data:Array(Math.ceil(rsiV.length/f)).fill(30), borderColor:'rgba(74,222,128,0.4)',  borderWidth:1, borderDash:[4,4], pointRadius:0, fill:false },
      ]},
      options:{ responsive:true, plugins:{legend:{display:false},tooltip:{...tooltipDefaults}}, scales:{ x:{ticks:{maxTicksLimit:6},grid:{display:false}}, y:{min:0,max:100,ticks:{callback:v=>v},grid:{color:'rgba(255,255,255,0.04)'}} } }
    });
  }

  // Bollinger Bands
  if (prices.length >= 20) {
    const bbL=[],upper=[],lower=[],mid=[],ps=[];
    for (let i=19;i<prices.length;i++) {
      const seg=prices.slice(i-19,i+1);
      const avg=seg.reduce((a,b)=>a+b)/20;
      const std=Math.sqrt(seg.reduce((s,v)=>s+(v-avg)**2,0)/20);
      mid.push(avg); upper.push(avg+2*std); lower.push(avg-2*std); ps.push(prices[i]); bbL.push(labels[i]);
    }
    const f=Math.max(1,Math.floor(bbL.length/25));
    const sl=a=>a.filter((_,i)=>i%f===0);
    const bbCtx=document.getElementById('bollingerChart')?.getContext('2d');
    if (bbCtx) {
      const bg=bbCtx.createLinearGradient(0,0,0,200);
      bg.addColorStop(0,'rgba(34,211,238,0.06)'); bg.addColorStop(1,'rgba(34,211,238,0)');
      makeChart('bollingerChart',{
        type:'line',
        data:{ labels:sl(bbL), datasets:[
          { label:'Upper', data:sl(upper), borderColor:'rgba(34,211,238,0.3)', borderWidth:1, pointRadius:0, fill:false, tension:0.3 },
          { label:'Mid',   data:sl(mid),   borderColor:CYAN, borderWidth:1.5, pointRadius:0, fill:false, tension:0.3 },
          { label:'Lower', data:sl(lower), borderColor:'rgba(34,211,238,0.3)', borderWidth:1, pointRadius:0, fill:'+1', backgroundColor:bg, tension:0.3 },
          { label:'Price', data:sl(ps),    borderColor:'rgba(255,255,255,0.25)', borderWidth:1, pointRadius:0, fill:false, tension:0.3 },
        ]},
        options:{ responsive:true, plugins:{legend:{display:false},tooltip:{...tooltipDefaults}}, scales:{ x:{ticks:{maxTicksLimit:6},grid:{display:false}}, y:{ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'rgba(255,255,255,0.04)'}} } }
      });
    }
  }

  // Returns Distribution
  if (prices.length >= 7) {
    const returns=prices.slice(1).map((v,i)=>((v-prices[i])/prices[i])*100);
    const bins=Array.from({length:20},(_,i)=>-10+i);
    const hist=Array(20).fill(0);
    returns.forEach(r=>{ const idx=Math.min(19,Math.max(0,Math.floor(r+10))); hist[idx]++; });
    makeChart('returnsChart',{
      type:'bar',
      data:{ labels:bins.map(b=>b.toFixed(0)+'%'), datasets:[{ label:'Freq', data:hist, backgroundColor:bins.map(b=>b<0?'rgba(251,113,133,0.5)':'rgba(74,222,128,0.5)'), borderColor:bins.map(b=>b<0?RED:GREEN), borderWidth:1, borderRadius:2 }] },
      options:{ responsive:true, plugins:{legend:{display:false},tooltip:{...tooltipDefaults,callbacks:{label:c=>c.parsed.y+' periods'}}}, scales:{ x:{ticks:{maxTicksLimit:8},grid:{display:false}}, y:{ticks:{stepSize:1},grid:{color:'rgba(255,255,255,0.04)'}} } }
    });
  }
}

// ═══════════════════════════════════════════════════
// GLOBAL TABLE
// ═══════════════════════════════════════════════════
function buildGlobalTable(coins) {
  const tbody = document.getElementById('global-tbody');
  if (!tbody) return;
  const totalMcap = coins.reduce((s,c)=>s+(c.market_cap||0),0);
  tbody.innerHTML = coins.map((c,i) => {
    const ch24=c.price_change_percentage_24h, ch7=c.price_change_percentage_7d_in_currency;
    const dom = totalMcap>0 ? ((c.market_cap/totalMcap)*100).toFixed(1)+'%' : '—';
    const cs = v => v==null?'':v>=0?'color:var(--green)':'color:var(--red)';
    return `<tr>
      <td>${i+1}</td>
      <td class="asset-symbol">${c.symbol?.toUpperCase()}</td>
      <td>${fmt.price(c.current_price)}</td>
      <td style="${cs(ch24)}">${fmt.pct(ch24)}</td>
      <td style="${cs(ch7)}">${fmt.pct(ch7)}</td>
      <td>${fmt.compact(c.market_cap)}</td>
      <td>${fmt.compact(c.total_volume)}</td>
      <td style="color:var(--text3)">${dom}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════════════════
// DOMINANCE HORIZONTAL BAR
// ═══════════════════════════════════════════════════
function buildDominanceChart(coins) {
  const top7 = coins.slice(0,7);
  const totalMcap = coins.reduce((s,c)=>s+(c.market_cap||0),0);
  const labels = top7.map(c=>c.symbol?.toUpperCase());
  const data   = top7.map(c=>parseFloat((c.market_cap/totalMcap*100).toFixed(2)));
  const colors = [CYAN,'rgba(167,139,250,0.8)','rgba(74,222,128,0.8)','rgba(251,191,36,0.8)','rgba(251,113,133,0.8)','rgba(56,189,248,0.8)','rgba(232,121,249,0.8)'];
  makeChart('dominanceChart',{
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor:colors, borderColor:colors, borderWidth:0, borderRadius:4 }] },
    options:{
      indexAxis:'y', responsive:true,
      plugins:{legend:{display:false}, tooltip:{...tooltipDefaults, callbacks:{label:c=>c.parsed.x.toFixed(2)+'% market cap'}}},
      scales:{ x:{ticks:{callback:v=>v+'%'},grid:{color:'rgba(255,255,255,0.04)'}}, y:{ticks:{font:{size:10},color:'#e2e8f0'},grid:{display:false}} }
    }
  });
}

// ═══════════════════════════════════════════════════
// COINGECKO MARKET DATA
// ═══════════════════════════════════════════════════
let lastBtcPrice = null;
async function fetchCoinGeckoMarket() {
  try {
    const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,solana,binancecoin,ripple,cardano,avalanche-2,polkadot&order=market_cap_desc&sparkline=false&price_change_percentage=7d,30d');
    const data = await res.json();
    if (!data?.[0]) return;
    const btc = data[0];
    const price = btc.current_price;
    const change24 = btc.price_change_percentage_24h;
    const change7  = btc.price_change_percentage_7d_in_currency;
    const change30 = btc.price_change_percentage_30d_in_currency;

    const bigEl = document.getElementById('big-price');
    if (bigEl) {
      if (lastBtcPrice) { bigEl.classList.remove('flash-up','flash-dn'); void bigEl.offsetWidth; bigEl.classList.add(price>lastBtcPrice?'flash-up':'flash-dn'); }
      bigEl.textContent = fmt.price(price);
    }
    lastBtcPrice = price;

    const chEl = document.getElementById('price-change');
    if (chEl) { chEl.textContent = fmt.pct(change24); setColor(chEl, change24); }
    const absEl = document.getElementById('price-change-abs');
    if (absEl) { absEl.textContent = fmt.price(btc.price_change_24h); setColor(absEl, change24); }

    setText('price-high', fmt.price(btc.high_24h));
    setText('price-low',  fmt.price(btc.low_24h));
    setText('price-ath',  fmt.price(btc.ath));
    setText('mkt-cap',    fmt.compact(btc.market_cap));
    setText('volume',     fmt.compact(btc.total_volume));
    setText('circulating',(btc.circulating_supply/1e6).toFixed(3)+'M');
    setText('mkt-rank',   '#'+btc.market_cap_rank);
    setText('ath-metric', fmt.price(btc.ath));
    setText('ath-date',   new Date(btc.ath_date).toLocaleDateString());

    const ch7El=document.getElementById('change7d');  if(ch7El){ch7El.textContent=fmt.pct(change7); setColor(ch7El,change7);}
    const ch30El=document.getElementById('change30d'); if(ch30El){ch30El.textContent=fmt.pct(change30);setColor(ch30El,change30);}

    // Supply
    const mined = btc.circulating_supply;
    const pct = (mined/21000000*100).toFixed(2);
    const sb = document.getElementById('supply-bar');
    if (sb) sb.style.width = pct+'%';
    setText('supply-pct-label', pct+'%');
    setText('supply-mined', (mined/1e6).toFixed(3)+'M');
    setText('supply-left',  ((21000000-mined)/1e6).toFixed(3)+'M');
    setText('supply-mcap',  fmt.compact(btc.market_cap));
    setText('supply-vol',   fmt.compact(btc.total_volume));

    // Ticker
    ['t-price','t-price2'].forEach(id=>setText(id,fmt.price(price)));
    ['t-change','t-change2'].forEach(id=>setText(id,fmt.pct(change24)));
    ['t-mcap','t-mcap2'].forEach(id=>setText(id,fmt.compact(btc.market_cap)));
    ['t-vol','t-vol2'].forEach(id=>setText(id,fmt.compact(btc.total_volume)));

    buildGlobalTable(data);
    buildDominanceChart(data);
    setText('last-updated', 'Updated '+new Date().toLocaleTimeString());
  } catch(e) { console.error('Market error:', e); }
}

// ═══════════════════════════════════════════════════
// COINGECKO GLOBAL
// ═══════════════════════════════════════════════════
async function fetchGlobal() {
  try {
    const res = await fetch('https://api.coingecko.com/api/v3/global');
    const { data } = await res.json();
    if (!data) return;
    const dom = data.market_cap_percentage.btc?.toFixed(1)+'%';
    setText('dominance', dom);
    ['t-dom','t-dom2'].forEach(id=>setText(id,dom));
  } catch(e) {}
}

// ═══════════════════════════════════════════════════
// FEAR & GREED
// ═══════════════════════════════════════════════════
async function fetchFearGreed() {
  try {
    const res = await fetch('https://api.alternative.me/fng/?limit=1');
    const { data } = await res.json();
    if (!data?.[0]) return;
    const val = parseInt(data[0].value);
    const label = data[0].value_classification;
    setText('fg-value', val);
    setText('fg-label', label);

    // Arc animation
    const arc = document.getElementById('fg-arc');
    const valEl = document.getElementById('fg-value');
    if (arc) {
      const circumference = 2 * Math.PI * 50; // r=50
      const halfCirc = circumference / 2;
      const offset = halfCirc - (val / 100) * halfCirc;
      arc.style.strokeDashoffset = offset + halfCirc;
      // Color gradient
      let color;
      if (val <= 25)      { color = 'var(--red)';   }
      else if (val <= 45) { color = 'var(--gold)';  }
      else if (val <= 55) { color = 'var(--text2)'; }
      else if (val <= 75) { color = 'var(--cyan)';  }
      else                { color = 'var(--green)'; }
      arc.style.stroke = color;
      if (valEl) valEl.style.color = color;
    }
  } catch(e) {}
}

// ═══════════════════════════════════════════════════
// MEMPOOL
// ═══════════════════════════════════════════════════
async function fetchMempool() {
  try {
    const [feeRes, mempoolRes, blockRes] = await Promise.all([
      fetch('https://mempool.space/api/v1/fees/recommended'),
      fetch('https://mempool.space/api/mempool'),
      fetch('https://mempool.space/api/v1/blocks/tip/height'),
    ]);
    const fees = await feeRes.json();
    const mempool = await mempoolRes.json();
    const blockHeight = await blockRes.json();

    document.getElementById('mempool-content').innerHTML = `
      <div class="fee-tier">
        <span class="fee-label">Fastest</span>
        <span class="fee-pill fp-fast">${fees.fastestFee} sat/vB</span>
        <span class="fee-est">~10 min</span>
      </div>
      <div class="fee-tier">
        <span class="fee-label">Medium</span>
        <span class="fee-pill fp-mid">${fees.halfHourFee} sat/vB</span>
        <span class="fee-est">~30 min</span>
      </div>
      <div class="fee-tier">
        <span class="fee-label">Economy</span>
        <span class="fee-pill fp-slow">${fees.hourFee} sat/vB</span>
        <span class="fee-est">~60 min</span>
      </div>
      <div class="fee-tier">
        <span class="fee-label">Minimum</span>
        <span class="fee-pill fp-min">${fees.minimumFee} sat/vB</span>
        <span class="fee-est">low priority</span>
      </div>
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">
        <div class="kv-row" style="padding:5px 0;"><span class="kv-key">Pending TXs</span><span class="kv-val">${fmt.number(mempool.count)}</span></div>
        <div class="kv-row" style="padding:5px 0;"><span class="kv-key">Size</span><span class="kv-val">${(mempool.vsize/1e6).toFixed(2)} MB</span></div>
        <div class="kv-row" style="padding:5px 0;border-bottom:none;"><span class="kv-key">Total Fees</span><span class="kv-val">${(mempool.total_fee/1e8).toFixed(4)} BTC</span></div>
      </div>
    `;

    ['t-block','t-block2'].forEach(id=>setText(id,'#'+fmt.number(blockHeight)));
    ['t-mempool','t-mempool2'].forEach(id=>setText(id,fmt.number(mempool.count)));

    const NEXT_HALVING = 1050000;
    const blocksLeft = NEXT_HALVING - blockHeight;
    const halvingDate = new Date(Date.now() + blocksLeft * 600000);
    setText('halving-block', '#'+fmt.number(NEXT_HALVING));
    setText('halving-blocks-left', fmt.number(blocksLeft));
    setText('halving-date', halvingDate.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}));
    ['t-halving','t-halving2'].forEach(id=>setText(id,halvingDate.toLocaleDateString()));

    (function tick() {
      const diff = halvingDate - Date.now();
      if (diff <= 0) { ['hc-days','hc-hours','hc-mins','hc-secs'].forEach(id=>setText(id,'0')); return; }
      setText('hc-days',  Math.floor(diff/86400000));
      setText('hc-hours', Math.floor((diff%86400000)/3600000));
      setText('hc-mins',  Math.floor((diff%3600000)/60000));
      setText('hc-secs',  Math.floor((diff%60000)/1000));
      setTimeout(tick, 1000);
    })();
  } catch(e) { console.error('Mempool error:', e); }
}

// ═══════════════════════════════════════════════════
// BLOCKS FULL PAGE
// ═══════════════════════════════════════════════════
function timeAgo(ts) {
  const diff = Math.floor((Date.now()-ts*1000)/1000);
  if (diff<60) return diff+'s ago';
  if (diff<3600) return Math.floor(diff/60)+'m ago';
  if (diff<86400) return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

async function fetchBlocks() { /* dashboard mini — not used */ }

async function fetchBlocksFull() {
  try {
    const res = await fetch('https://mempool.space/api/v1/blocks');
    const blocks = await res.json();
    if (!blocks?.length) return;

    const avgSize = (blocks.reduce((s,b)=>s+b.size,0)/blocks.length/1e6).toFixed(2);
    const avgTxs  = Math.round(blocks.reduce((s,b)=>s+b.tx_count,0)/blocks.length);
    const avgFees = (blocks.reduce((s,b)=>s+(b.extras?.totalFees||0),0)/blocks.length/1e8).toFixed(4);
    const avgMedFee = (blocks.reduce((s,b)=>s+(b.extras?.medianFee||0),0)/blocks.length).toFixed(1);
    const times = [];
    for (let i=0;i<blocks.length-1;i++) times.push(Math.abs(blocks[i].timestamp-blocks[i+1].timestamp));
    const avgTime = times.length?(times.reduce((a,b)=>a+b,0)/times.length/60).toFixed(1):'—';

    setText('bp-height', fmt.number(blocks[0].height));
    setText('bp-avg-size', avgSize+' MB');
    setText('bp-avg-txs', fmt.number(avgTxs));
    setText('bp-avg-fees', avgFees+' BTC');
    setText('bp-avg-median-fee', avgMedFee+' sat/vB');
    setText('bp-avg-time', avgTime);
    setText('blocks-last-updated', 'Updated '+new Date().toLocaleTimeString());

    const tbody = document.getElementById('blocks-full-tbody');
    if (!tbody) return;
    tbody.innerHTML = blocks.map(b => {
      const fees=b.extras?.totalFees||0, medFee=b.extras?.medianFee||0;
      const feeRange=b.extras?.feeRange||[], pool=b.extras?.pool?.name||'Unknown';
      const sizeMB=(b.size/1e6).toFixed(3), weightMWU=(b.weight/1e6).toFixed(3);
      const fillPct=Math.min(100,(b.size/1572864*100)).toFixed(0);
      const feeBarHtml = feeRange.length>=2
        ? `<div class="fee-bar-mini">${feeRange.slice(0,-1).map((_,i)=>{ const h=i/(feeRange.length-2); const c=`rgba(${Math.round(34+h*217)},${Math.round(211-h*98)},${Math.round(238-h*105)},0.8)`; return `<div class="fee-segment" style="flex:1;background:${c}"></div>`; }).join('')}</div><div style="font-size:9px;color:var(--text3);margin-top:2px;">${feeRange[0]}–${feeRange[feeRange.length-1]}</div>`
        : `<span style="color:var(--text3);font-size:10px;">—</span>`;
      const ts=new Date(b.timestamp*1000).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      const medColor = medFee>50?'var(--red)':medFee>20?'var(--gold)':'var(--green)';
      return `<tr onclick="window.open('https://mempool.space/block/${b.id}','_blank')">
        <td style="color:var(--cyan);font-weight:600;">${fmt.number(b.height)}</td>
        <td style="color:var(--text2);font-size:10px;">${ts}</td>
        <td class="block-age">${timeAgo(b.timestamp)}</td>
        <td><span class="pool-badge">${pool}</span></td>
        <td>${fmt.number(b.tx_count)}</td>
        <td><div class="size-bar-wrap"><div class="size-bar" style="width:${fillPct}px;max-width:55px;"></div><span style="font-size:10px;">${sizeMB} MB</span></div></td>
        <td style="color:var(--text3);font-size:10px;">${weightMWU} MWU</td>
        <td style="color:var(--cyan);">${(fees/1e8).toFixed(4)} ₿</td>
        <td style="color:${medColor};">${medFee} sat/vB</td>
        <td>${feeBarHtml}</td>
        <td class="b-hash" title="${b.id}">${b.id.slice(0,18)}...${b.id.slice(-6)}</td>
      </tr>`;
    }).join('');
  } catch(e) { console.error('Blocks error:', e); }
}

// ═══════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════
async function init() {
  await Promise.allSettled([
    fetchCoinGeckoMarket(),
    fetchGlobal(),
    fetchFearGreed(),
    fetchMempool(),
    loadPriceChart(90),
  ]);
}
init();
setInterval(fetchCoinGeckoMarket, 30000);
setInterval(fetchGlobal, 60000);
setInterval(fetchFearGreed, 300000);
setInterval(fetchMempool, 30000);
setInterval(()=>{ if(document.getElementById('page-blocks').classList.contains('active')) fetchBlocksFull(); }, 60000);
</script>
</body>
</html>
