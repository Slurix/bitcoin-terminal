<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>₿ BITCOIN TERMINAL — LIVE DASHBOARD</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --btc: #f7931a;
    --btc-dim: #c4720e;
    --btc-glow: rgba(247, 147, 26, 0.4);
    --green: #00ff88;
    --red: #ff3366;
    --bg: #050508;
    --bg2: #0a0a10;
    --bg3: #0f0f18;
    --border: rgba(247, 147, 26, 0.2);
    --text: #e8d5b0;
    --dim: #6b5c42;
    --panel: rgba(10, 10, 16, 0.95);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid scanlines overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.15) 2px,
      rgba(0,0,0,0.15) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  /* Animated background */
  .bg-anim {
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 10% 0%, rgba(247,147,26,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 60% 80% at 90% 100%, rgba(247,147,26,0.04) 0%, transparent 60%),
      var(--bg);
    z-index: 0;
  }

  .bg-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(247,147,26,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(247,147,26,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    z-index: 0;
  }

  .wrap { position: relative; z-index: 1; padding: 20px; max-width: 1800px; margin: 0 auto; }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border: 1px solid var(--border);
    background: var(--panel);
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  header::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--btc), transparent);
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 22px;
    font-weight: 900;
    color: var(--btc);
    letter-spacing: 4px;
    text-shadow: 0 0 20px var(--btc-glow);
  }
  .logo span { color: var(--text); font-weight: 400; font-size: 14px; letter-spacing: 2px; display: block; }

  .header-right { display: flex; align-items: center; gap: 24px; }

  .live-badge {
    display: flex; align-items: center; gap: 8px;
    font-size: 11px; letter-spacing: 2px; color: var(--green);
  }
  .live-dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--green);
    animation: pulse-green 1.5s ease-in-out infinite;
  }
  @keyframes pulse-green {
    0%,100% { box-shadow: 0 0 4px var(--green); }
    50% { box-shadow: 0 0 12px var(--green), 0 0 20px var(--green); }
  }

  #clock { font-family: 'Share Tech Mono'; font-size: 13px; color: var(--dim); }
  #last-updated { font-size: 10px; color: var(--dim); letter-spacing: 1px; }

  /* NAV */
  nav {
    display: flex; gap: 2px; margin-bottom: 20px;
    border: 1px solid var(--border);
    background: var(--panel);
    padding: 6px;
  }
  .nav-link {
    padding: 8px 20px; font-family: 'Orbitron'; font-size: 10px; letter-spacing: 2px;
    text-decoration: none; color: var(--dim); text-transform: uppercase;
    border: 1px solid transparent; transition: all 0.2s;
  }
  .nav-link:hover { color: var(--btc); border-color: var(--border); }
  .nav-link.active { color: var(--btc); border-color: var(--btc); background: rgba(247,147,26,0.08); }

  /* BIG PRICE */
  .price-hero {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    gap: 40px;
    padding: 28px 32px;
    border: 1px solid var(--border);
    background: var(--panel);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .price-hero::before {
    content: '₿';
    position: absolute;
    right: 20px; top: 50%;
    transform: translateY(-50%);
    font-size: 180px;
    font-weight: 900;
    color: rgba(247,147,26,0.04);
    line-height: 1;
    font-family: 'Orbitron';
  }

  #big-price {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(36px, 5vw, 68px);
    font-weight: 900;
    color: var(--btc);
    text-shadow: 0 0 30px var(--btc-glow);
    letter-spacing: -1px;
    animation: flicker 8s infinite;
  }
  @keyframes flicker {
    0%,96%,100% { opacity: 1; }
    97% { opacity: 0.9; }
    98% { opacity: 1; }
    99% { opacity: 0.95; }
  }

  #price-change {
    font-family: 'Orbitron'; font-size: 22px; font-weight: 700;
    transition: color 0.5s;
  }
  .price-meta { display: flex; flex-direction: column; gap: 6px; }
  .price-meta-item { font-size: 11px; letter-spacing: 1px; color: var(--dim); }
  .price-meta-item span { color: var(--text); font-size: 13px; }

  .price-stats { display: flex; gap: 32px; margin-left: auto; }
  .stat-box { text-align: center; }
  .stat-box .label { font-size: 10px; letter-spacing: 2px; color: var(--dim); text-transform: uppercase; margin-bottom: 6px; }
  .stat-box .value { font-family: 'Share Tech Mono'; font-size: 16px; color: var(--text); }

  /* MAIN GRID */
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
  }

  /* PANEL */
  .panel {
    border: 1px solid var(--border);
    background: var(--panel);
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }
  .panel:hover { border-color: rgba(247,147,26,0.4); }

  .panel-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--btc);
    text-transform: uppercase;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .panel-title::before { content: '//'; color: var(--dim); }

  .col-3 { grid-column: span 3; }
  .col-4 { grid-column: span 4; }
  .col-5 { grid-column: span 5; }
  .col-6 { grid-column: span 6; }
  .col-7 { grid-column: span 7; }
  .col-8 { grid-column: span 8; }
  .col-9 { grid-column: span 9; }
  .col-12 { grid-column: span 12; }

  canvas { width: 100% !important; }

  /* METRIC CARDS */
  .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
  .metric-card {
    padding: 14px;
    background: rgba(247,147,26,0.04);
    border: 1px solid rgba(247,147,26,0.1);
  }
  .metric-card .m-label { font-size: 9px; letter-spacing: 2px; color: var(--dim); margin-bottom: 6px; text-transform: uppercase; }
  .metric-card .m-value { font-family: 'Share Tech Mono'; font-size: 15px; color: var(--btc); }
  .metric-card .m-sub { font-size: 10px; color: var(--dim); margin-top: 3px; }

  /* FEAR GREED */
  .fg-container { display: flex; flex-direction: column; align-items: center; gap: 12px; }
  #fg-value { font-family: 'Orbitron'; font-size: 52px; font-weight: 900; }
  #fg-label { font-family: 'Orbitron'; font-size: 14px; letter-spacing: 3px; }
  .fg-bar-wrap { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
  .fg-bar { height: 100%; border-radius: 4px; transition: width 1s ease; }

  /* MEMPOOL */
  .mempool-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(247,147,26,0.06); font-size: 12px; }
  .mempool-row:last-child { border-bottom: none; }
  .fee-badge { padding: 2px 8px; font-size: 10px; letter-spacing: 1px; }
  .fee-fast { background: rgba(255,51,102,0.15); color: var(--red); border: 1px solid rgba(255,51,102,0.3); }
  .fee-med { background: rgba(247,147,26,0.15); color: var(--btc); border: 1px solid var(--border); }
  .fee-slow { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.2); }

  /* BLOCKS */
  .blocks-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 6px; }
  .block-card {
    min-width: 90px;
    padding: 10px;
    background: rgba(247,147,26,0.05);
    border: 1px solid rgba(247,147,26,0.15);
    flex-shrink: 0;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .block-card:hover { background: rgba(247,147,26,0.12); border-color: var(--btc); }
  .block-card .b-height { font-family: 'Orbitron'; font-size: 11px; color: var(--btc); margin-bottom: 4px; }
  .block-card .b-txs { font-size: 10px; color: var(--dim); }
  .block-card .b-size { font-size: 10px; color: var(--text); }

  /* SPARKLINE STATS */
  .exchange-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(247,147,26,0.06); }
  .exchange-row:last-child { border-bottom: none; }
  .ex-name { font-size: 12px; color: var(--text); }
  .ex-vol { font-family: 'Share Tech Mono'; font-size: 12px; color: var(--btc); }
  .ex-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.06); margin: 0 12px; border-radius: 2px; overflow: hidden; }
  .ex-bar-fill { height: 100%; background: linear-gradient(90deg, var(--btc-dim), var(--btc)); border-radius: 2px; }

  /* LOADING */
  .loading {
    display: flex; align-items: center; justify-content: center;
    height: 100px; color: var(--dim); font-size: 12px; letter-spacing: 2px;
    animation: blink 1s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* SUPPLY BAR */
  .supply-bar-wrap { margin: 16px 0 8px; }
  .supply-bar-track { height: 20px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; position: relative; }
  .supply-bar-fill { height: 100%; background: linear-gradient(90deg, var(--btc-dim), var(--btc)); border-radius: 2px; transition: width 2s ease; }
  .supply-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--dim); margin-top: 6px; }

  /* HALVING */
  .halving-countdown { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
  .hc-box { text-align: center; padding: 12px 8px; background: rgba(247,147,26,0.05); border: 1px solid rgba(247,147,26,0.1); }
  .hc-num { font-family: 'Orbitron'; font-size: 28px; font-weight: 700; color: var(--btc); }
  .hc-label { font-size: 9px; letter-spacing: 2px; color: var(--dim); text-transform: uppercase; margin-top: 4px; }

  /* PRICE TICKER AT BOTTOM */
  .ticker-wrap { overflow: hidden; border-top: 1px solid var(--border); margin-top: 20px; padding: 10px 0; }
  .ticker { display: flex; gap: 60px; animation: scroll-ticker 30s linear infinite; white-space: nowrap; }
  @keyframes scroll-ticker { from { transform: translateX(0); } to { transform: translateX(-50%); } }
  .ticker-item { font-family: 'Share Tech Mono'; font-size: 12px; color: var(--dim); }
  .ticker-item span { color: var(--btc); margin-left: 6px; }

  /* PULSE animation for value changes */
  .flash-up { animation: flashup 0.5s ease-out; }
  .flash-dn { animation: flashdn 0.5s ease-out; }
  @keyframes flashup { from { color: var(--green); } to { } }
  @keyframes flashdn { from { color: var(--red); } to { } }

  /* TIMEFRAME BUTTONS */
  .tf-buttons { display: flex; gap: 6px; margin-bottom: 12px; }
  .tf-btn {
    padding: 4px 10px; font-size: 9px; letter-spacing: 1px;
    font-family: 'JetBrains Mono'; cursor: pointer;
    background: transparent; border: 1px solid rgba(247,147,26,0.2);
    color: var(--dim); text-transform: uppercase;
    transition: all 0.2s;
  }
  .tf-btn:hover, .tf-btn.active {
    background: rgba(247,147,26,0.15);
    border-color: var(--btc); color: var(--btc);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .col-3 { grid-column: span 6; }
    .col-4 { grid-column: span 6; }
    .col-5 { grid-column: span 12; }
    .col-7 { grid-column: span 12; }
    .col-8 { grid-column: span 12; }
    .col-9 { grid-column: span 12; }
  }
  @media (max-width: 768px) {
    .col-3, .col-4, .col-6 { grid-column: span 12; }
    .price-stats { display: none; }
    .price-hero { flex-wrap: wrap; }
    #big-price { font-size: 36px; }
    .halving-countdown { grid-template-columns: repeat(2, 1fr); }
  }

  /* Error state */
  .error-text { color: var(--red); font-size: 11px; text-align: center; padding: 20px; }

  /* Table */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { font-size: 9px; letter-spacing: 2px; color: var(--dim); text-transform: uppercase; padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border); }
  .data-table td { font-size: 11px; padding: 8px 8px; border-bottom: 1px solid rgba(247,147,26,0.04); font-family: 'Share Tech Mono'; }
  .data-table tr:hover td { background: rgba(247,147,26,0.03); }
</style>
</head>
<body>
<div class="bg-anim"></div>
<div class="bg-grid"></div>

<div class="wrap">
  <!-- HEADER -->
  <header>
    <div class="logo">
      ₿ITCOIN TERMINAL
      <span>REAL-TIME MARKET INTELLIGENCE DASHBOARD</span>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE DATA</div>
      <div id="clock">--:--:--</div>
      <div id="last-updated">UPDATING...</div>
    </div>
  </header>

  <!-- NAV -->
  <nav>
    <a href="index.html" class="nav-link active">⬡ DASHBOARD</a>
    <a href="news.html" class="nav-link">⬡ NEWS FEED</a>
  </nav>

  <!-- PRICE HERO -->
  <div class="price-hero">
    <div>
      <div style="font-size:10px;letter-spacing:3px;color:var(--dim);margin-bottom:8px;">BTC / USD</div>
      <div id="big-price">$—</div>
    </div>
    <div class="price-meta">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
        <div id="price-change" style="color:var(--dim);">±0.00%</div>
        <div id="price-change-abs" style="font-size:14px;color:var(--dim);">($0.00)</div>
      </div>
      <div class="price-meta-item">24H HIGH: <span id="price-high">—</span></div>
      <div class="price-meta-item">24H LOW: <span id="price-low">—</span></div>
      <div class="price-meta-item">ATH: <span id="price-ath">—</span></div>
    </div>
    <div class="price-stats">
      <div class="stat-box">
        <div class="label">Market Cap</div>
        <div class="value" id="mkt-cap">—</div>
      </div>
      <div class="stat-box">
        <div class="label">24H Volume</div>
        <div class="value" id="volume">—</div>
      </div>
      <div class="stat-box">
        <div class="label">BTC Dominance</div>
        <div class="value" id="dominance">—</div>
      </div>
      <div class="stat-box">
        <div class="label">Circulating</div>
        <div class="value" id="circulating">—</div>
      </div>
      <div class="stat-box">
        <div class="label">Total Supply</div>
        <div class="value">21,000,000</div>
      </div>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">

    <!-- PRICE CHART (big) -->
    <div class="panel col-8">
      <div class="panel-title">PRICE HISTORY (USD)</div>
      <div class="tf-buttons">
        <button class="tf-btn" onclick="loadPriceChart(1, this)">1D</button>
        <button class="tf-btn active" onclick="loadPriceChart(7, this)">7D</button>
        <button class="tf-btn" onclick="loadPriceChart(30, this)">30D</button>
        <button class="tf-btn" onclick="loadPriceChart(90, this)">3M</button>
        <button class="tf-btn" onclick="loadPriceChart(365, this)">1Y</button>
        <button class="tf-btn" onclick="loadPriceChart(1825, this)">5Y</button>
        <button class="tf-btn" onclick="loadPriceChart('max', this)">MAX</button>
      </div>
      <canvas id="priceChart" height="220"></canvas>
    </div>

    <!-- FEAR & GREED + MARKET METRICS -->
    <div class="panel col-4">
      <div class="panel-title">FEAR & GREED INDEX</div>
      <div class="fg-container">
        <div id="fg-value" style="color:var(--dim);">—</div>
        <div id="fg-label" style="color:var(--dim);">LOADING</div>
        <div class="fg-bar-wrap" style="width:100%;">
          <div class="fg-bar" id="fg-bar" style="width:0%;background:var(--dim);"></div>
        </div>
        <div style="display:flex;justify-content:space-between;width:100%;font-size:9px;color:var(--dim);letter-spacing:1px;margin-top:2px;">
          <span>EXTREME FEAR</span><span>EXTREME GREED</span>
        </div>
      </div>
      <div style="margin-top:20px;">
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="m-label">RANK</div>
            <div class="m-value" id="mkt-rank">#—</div>
          </div>
          <div class="metric-card">
            <div class="m-label">Price Change 7D</div>
            <div class="m-value" id="change7d">—</div>
          </div>
          <div class="metric-card">
            <div class="m-label">Price Change 30D</div>
            <div class="m-value" id="change30d">—</div>
          </div>
          <div class="metric-card">
            <div class="m-label">All Time High</div>
            <div class="m-value" id="ath-metric">—</div>
            <div class="m-sub" id="ath-date">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- VOLUME CHART -->
    <div class="panel col-6">
      <div class="panel-title">TRADING VOLUME (30D)</div>
      <canvas id="volumeChart" height="160"></canvas>
    </div>

    <!-- MARKET CAP CHART -->
    <div class="panel col-6">
      <div class="panel-title">MARKET CAP (30D)</div>
      <canvas id="mcapChart" height="160"></canvas>
    </div>

    <!-- SUPPLY PANEL -->
    <div class="panel col-4">
      <div class="panel-title">BITCOIN SUPPLY</div>
      <div class="supply-bar-wrap">
        <div class="supply-bar-track">
          <div class="supply-bar-fill" id="supply-bar" style="width:0%"></div>
        </div>
        <div class="supply-labels">
          <span>MINED: <span id="supply-mined">—</span></span>
          <span>LEFT: <span id="supply-left">—</span></span>
        </div>
      </div>
      <div style="margin-top:12px;">
        <canvas id="supplyDonut" height="160"></canvas>
      </div>
    </div>

    <!-- HALVING COUNTDOWN -->
    <div class="panel col-4">
      <div class="panel-title">NEXT HALVING COUNTDOWN</div>
      <div style="font-size:10px;color:var(--dim);margin-bottom:4px;">EST. DATE: <span id="halving-date" style="color:var(--btc);">—</span></div>
      <div style="font-size:10px;color:var(--dim);margin-bottom:4px;">BLOCK HEIGHT: <span id="halving-block" style="color:var(--btc);">—</span></div>
      <div style="font-size:10px;color:var(--dim);margin-bottom:2px;">BLOCKS REMAINING: <span id="halving-blocks-left" style="color:var(--btc);">—</span></div>
      <div class="halving-countdown" id="halving-cd">
        <div class="hc-box"><div class="hc-num" id="hc-days">—</div><div class="hc-label">Days</div></div>
        <div class="hc-box"><div class="hc-num" id="hc-hours">—</div><div class="hc-label">Hours</div></div>
        <div class="hc-box"><div class="hc-num" id="hc-mins">—</div><div class="hc-label">Mins</div></div>
        <div class="hc-box"><div class="hc-num" id="hc-secs">—</div><div class="hc-label">Secs</div></div>
      </div>
      <div style="margin-top:14px;font-size:10px;color:var(--dim);">
        CURRENT REWARD: <span id="block-reward" style="color:var(--btc);">3.125 BTC</span><br>
        AFTER HALVING: <span style="color:var(--dim);">1.5625 BTC</span>
      </div>
    </div>

    <!-- MEMPOOL / FEES -->
    <div class="panel col-4">
      <div class="panel-title">MEMPOOL & FEES</div>
      <div id="mempool-content">
        <div class="loading">QUERYING MEMPOOL...</div>
      </div>
    </div>

    <!-- RECENT BLOCKS -->
    <div class="panel col-8">
      <div class="panel-title">LATEST BLOCKS</div>
      <div class="blocks-row" id="blocks-row">
        <div class="loading">SYNCING CHAIN...</div>
      </div>
    </div>

    <!-- PRICE CANDLESTICK PROXY (OHLC bar chart) -->
    <div class="panel col-6">
      <div class="panel-title">OHLC PRICE ACTION (14D)</div>
      <canvas id="ohlcChart" height="180"></canvas>
    </div>

    <!-- DOMINANCE GAUGE -->
    <div class="panel col-3">
      <div class="panel-title">CRYPTO DOMINANCE</div>
      <canvas id="dominanceChart" height="180"></canvas>
    </div>

    <!-- EXCHANGE VOLUME -->
    <div class="panel col-3">
      <div class="panel-title">EXCHANGE VOLUME</div>
      <div id="exchange-vol-content">
        <div class="loading">FETCHING...</div>
      </div>
    </div>

    <!-- VOLATILITY -->
    <div class="panel col-6">
      <div class="panel-title">30D RETURNS DISTRIBUTION</div>
      <canvas id="returnsChart" height="160"></canvas>
    </div>

    <!-- PRICE CORRELATION (moving avg) -->
    <div class="panel col-6">
      <div class="panel-title">MOVING AVERAGES (30D)</div>
      <canvas id="maChart" height="160"></canvas>
    </div>

    <!-- RSI INDICATOR -->
    <div class="panel col-6">
      <div class="panel-title">RSI INDICATOR (14-DAY)</div>
      <canvas id="rsiChart" height="140"></canvas>
      <div style="display:flex;gap:20px;margin-top:8px;font-size:10px;color:var(--dim);">
        <span>▬ <span style="color:var(--red);">OVERBOUGHT (70)</span></span>
        <span>▬ <span style="color:var(--green);">OVERSOLD (30)</span></span>
        <span>▬ <span style="color:var(--btc);">RSI</span></span>
      </div>
    </div>

    <!-- BOLLINGER BANDS -->
    <div class="panel col-6">
      <div class="panel-title">BOLLINGER BANDS (20D)</div>
      <canvas id="bollingerChart" height="140"></canvas>
    </div>

    <!-- GLOBAL STATS TABLE -->
    <div class="panel col-12">
      <div class="panel-title">GLOBAL CRYPTO MARKET SNAPSHOT</div>
      <table class="data-table" id="global-table">
        <thead>
          <tr>
            <th>#</th>
            <th>ASSET</th>
            <th>PRICE</th>
            <th>24H %</th>
            <th>7D %</th>
            <th>MARKET CAP</th>
            <th>VOLUME 24H</th>
            <th>DOMINANCE</th>
          </tr>
        </thead>
        <tbody id="global-tbody">
          <tr><td colspan="8" class="loading">LOADING MARKET DATA...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- TICKER -->
  <div class="ticker-wrap">
    <div class="ticker" id="ticker">
      <div class="ticker-item">BTC/USD<span id="t-price">$—</span></div>
      <div class="ticker-item">24H CHANGE<span id="t-change">—</span></div>
      <div class="ticker-item">MARKET CAP<span id="t-mcap">—</span></div>
      <div class="ticker-item">VOLUME<span id="t-vol">—</span></div>
      <div class="ticker-item">BTC DOMINANCE<span id="t-dom">—</span></div>
      <div class="ticker-item">BLOCK HEIGHT<span id="t-block">—</span></div>
      <div class="ticker-item">MEMPOOL TXS<span id="t-mempool">—</span></div>
      <div class="ticker-item">NEXT HALVING<span id="t-halving">—</span></div>
      <!-- duplicated for infinite scroll -->
      <div class="ticker-item">BTC/USD<span id="t-price2">$—</span></div>
      <div class="ticker-item">24H CHANGE<span id="t-change2">—</span></div>
      <div class="ticker-item">MARKET CAP<span id="t-mcap2">—</span></div>
      <div class="ticker-item">VOLUME<span id="t-vol2">—</span></div>
      <div class="ticker-item">BTC DOMINANCE<span id="t-dom2">—</span></div>
      <div class="ticker-item">BLOCK HEIGHT<span id="t-block2">—</span></div>
      <div class="ticker-item">MEMPOOL TXS<span id="t-mempool2">—</span></div>
      <div class="ticker-item">NEXT HALVING<span id="t-halving2">—</span></div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════
const fmt = {
  price: v => v != null ? '$' + Number(v).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) : '—',
  compact: v => {
    if (!v) return '—';
    if (v >= 1e12) return '$' + (v/1e12).toFixed(2) + 'T';
    if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'B';
    if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'M';
    return '$' + v.toLocaleString();
  },
  pct: v => v != null ? (v >= 0 ? '+' : '') + v.toFixed(2) + '%' : '—',
  btc: v => v != null ? Number(v).toLocaleString('en-US', {maximumFractionDigits:0}) + ' BTC' : '—',
  number: v => v != null ? Number(v).toLocaleString() : '—',
};

function setColor(el, val) {
  if (!el) return;
  el.style.color = val > 0 ? 'var(--green)' : val < 0 ? 'var(--red)' : 'var(--dim)';
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

// Clock
function updateClock() {
  document.getElementById('clock').textContent = new Date().toUTCString().slice(17, 25) + ' UTC';
}
setInterval(updateClock, 1000);
updateClock();

// Chart defaults
Chart.defaults.color = '#6b5c42';
Chart.defaults.borderColor = 'rgba(247,147,26,0.08)';
Chart.defaults.font.family = "'JetBrains Mono', monospace";
Chart.defaults.font.size = 10;

const BTC_ORANGE = 'rgba(247,147,26,1)';
const BTC_FILL = 'rgba(247,147,26,0.1)';
const GREEN = 'rgba(0,255,136,1)';
const RED = 'rgba(255,51,102,1)';

// ═══════════════════════════════════════
// CHARTS REGISTRY
// ═══════════════════════════════════════
const charts = {};

function makeChart(id, config) {
  const ctx = document.getElementById(id)?.getContext('2d');
  if (!ctx) return null;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, config);
  return charts[id];
}

// ═══════════════════════════════════════
// COINGECKO RATE-LIMIT QUEUE
// Free tier: ~30 req/min → enforce 1 req per 2.5s max
// ═══════════════════════════════════════
const CG_BASE = 'https://api.coingecko.com/api/v3';
let cgQueue = Promise.resolve();
let cgBackoffMs = 0;
const CG_MIN_GAP = 2500; // ms between requests

function cgFetch(path) {
  cgQueue = cgQueue.then(() => new Promise(resolve => setTimeout(resolve, CG_MIN_GAP + cgBackoffMs)));
  return cgQueue.then(async () => {
    const res = await fetch(CG_BASE + path);
    if (res.status === 429) {
      cgBackoffMs = Math.min((cgBackoffMs || 5000) * 2, 60000);
      console.warn(`CoinGecko 429 — backing off ${cgBackoffMs/1000}s`);
      await new Promise(r => setTimeout(r, cgBackoffMs));
      throw new Error('rate_limited');
    }
    cgBackoffMs = 0; // reset backoff on success
    return res.json();
  });
}

// sessionStorage cache helper
const MARKET_CACHE_KEY = 'btc_market_cache';
const MARKET_CACHE_TTL = 90 * 1000; // 90 seconds

function getCachedMarket() {
  try {
    const raw = sessionStorage.getItem(MARKET_CACHE_KEY);
    if (!raw) return null;
    const { ts, data } = JSON.parse(raw);
    if (Date.now() - ts < MARKET_CACHE_TTL) return data;
  } catch(e) {}
  return null;
}
function setCachedMarket(data) {
  try { sessionStorage.setItem(MARKET_CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch(e) {}
}

// Chart data cache: keyed by days, 5-min TTL
const chartCache = {};
const CHART_CACHE_TTL = 5 * 60 * 1000;

// ═══════════════════════════════════════
// API: COINGECKO — market + global merged
// One batched cycle instead of two separate calls
// ═══════════════════════════════════════
let lastBtcPrice = null;

async function fetchCoinGeckoMarket() {
  // Try cache first — render immediately, then refresh in background
  const cached = getCachedMarket();
  if (cached) { applyMarketData(cached); }

  try {
    const data = await cgFetch('/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,solana,binancecoin,ripple,cardano,avalanche-2,polkadot&order=market_cap_desc&sparkline=false&price_change_percentage=7d,30d');
    if (!data || !data[0]) return;
    setCachedMarket(data);
    applyMarketData(data);
  } catch(e) {
    if (e.message !== 'rate_limited') console.error('CoinGecko market error:', e);
  }
}

function applyMarketData(data) {
    const btc = data[0];
    const price = btc.current_price;
    const change24 = btc.price_change_percentage_24h;
    const change7 = btc.price_change_percentage_7d_in_currency;
    const change30 = btc.price_change_percentage_30d_in_currency;

    const bigPrice = document.getElementById('big-price');
    if (bigPrice) {
      const wasPrice = lastBtcPrice;
      bigPrice.textContent = fmt.price(price);
      if (wasPrice) {
        bigPrice.classList.remove('flash-up','flash-dn');
        void bigPrice.offsetWidth;
        bigPrice.classList.add(price > wasPrice ? 'flash-up' : 'flash-dn');
      }
    }
    lastBtcPrice = price;

    const changeEl = document.getElementById('price-change');
    if (changeEl) { changeEl.textContent = fmt.pct(change24); setColor(changeEl, change24); }

    const absEl = document.getElementById('price-change-abs');
    if (absEl) { absEl.textContent = '(' + fmt.price(btc.price_change_24h) + ')'; setColor(absEl, change24); }

    setText('price-high', fmt.price(btc.high_24h));
    setText('price-low', fmt.price(btc.low_24h));
    setText('price-ath', fmt.price(btc.ath));
    setText('mkt-cap', fmt.compact(btc.market_cap));
    setText('volume', fmt.compact(btc.total_volume));
    setText('circulating', (btc.circulating_supply / 1e6).toFixed(3) + 'M');
    setText('mkt-rank', '#' + btc.market_cap_rank);

    const c7el = document.getElementById('change7d');
    if (c7el) { c7el.textContent = fmt.pct(change7); setColor(c7el, change7); }
    const c30el = document.getElementById('change30d');
    if (c30el) { c30el.textContent = fmt.pct(change30); setColor(c30el, change30); }

    setText('ath-metric', fmt.price(btc.ath));
    setText('ath-date', new Date(btc.ath_date).toLocaleDateString());

    const mined = btc.circulating_supply;
    const pct = (mined / 21000000 * 100).toFixed(2);
    const supplyBar = document.getElementById('supply-bar');
    if (supplyBar) supplyBar.style.width = pct + '%';
    setText('supply-mined', (mined/1e6).toFixed(3) + 'M');
    setText('supply-left', ((21000000 - mined)/1e6).toFixed(3) + 'M');

    makeChart('supplyDonut', {
      type: 'doughnut',
      data: { labels: ['Mined', 'Unmined'], datasets: [{ data: [mined, 21000000 - mined], backgroundColor: ['rgba(247,147,26,0.8)','rgba(247,147,26,0.08)'], borderColor: ['rgba(247,147,26,1)','rgba(247,147,26,0.2)'], borderWidth: 1 }] },
      options: { responsive: true, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.label + ': ' + (c.raw/1e6).toFixed(2) + 'M BTC' } } } }
    });

    ['t-price','t-price2'].forEach(id => setText(id, fmt.price(price)));
    ['t-change','t-change2'].forEach(id => setText(id, fmt.pct(change24)));
    ['t-mcap','t-mcap2'].forEach(id => setText(id, fmt.compact(btc.market_cap)));
    ['t-vol','t-vol2'].forEach(id => setText(id, fmt.compact(btc.total_volume)));

    buildGlobalTable(data);
    buildDominanceChart(data);
    buildExchangeVolume(data);
    document.getElementById('last-updated').textContent = 'UPDATED ' + new Date().toLocaleTimeString();
}

// ═══════════════════════════════════════
// COINGECKO GLOBAL — merged into market cycle
// Only called separately on first load (staggered)
// ═══════════════════════════════════════
async function fetchGlobal() {
  try {
    const data = await cgFetch('/global');
    if (!data?.data) return;
    const dom = data.data.market_cap_percentage.btc?.toFixed(1) + '%';
    setText('dominance', dom);
    ['t-dom','t-dom2'].forEach(id => setText(id, dom));
  } catch(e) {}
}

// ═══════════════════════════════════════
// PRICE CHART — cached per timeframe, 5-min TTL
// ═══════════════════════════════════════
let activeDays = 7;
async function loadPriceChart(days, triggerEl) {
  activeDays = days;
  document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
  if (triggerEl) triggerEl.classList.add('active');
  else document.querySelectorAll('.tf-btn')[1]?.classList.add('active'); // default 7D

  // Serve from cache if fresh
  const cacheKey = 'chart_' + days;
  const cached = chartCache[cacheKey];
  if (cached && Date.now() - cached.ts < CHART_CACHE_TTL) {
    renderPriceCharts(cached.data, days);
    return;
  }

  try {
    const data = await cgFetch(`/coins/bitcoin/market_chart?vs_currency=usd&days=${days}`);
    if (!data || !data.prices) return;
    chartCache['chart_' + days] = { ts: Date.now(), data };
    renderPriceCharts(data, days);
  } catch(e) { if (e.message !== 'rate_limited') console.error('Price chart error:', e); }
}

function renderPriceCharts(data, days) {
    const labels = data.prices.map(p => {
      const d = new Date(p[0]);
      return days <= 1 ? d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
           : days <= 30 ? d.toLocaleDateString([], {month:'short',day:'numeric'})
           : d.toLocaleDateString([], {month:'short',year:'2-digit'});
    });
    const prices = data.prices.map(p => p[1]);
    const volumes = data.total_volumes ? data.total_volumes.map(v => v[1]) : [];
    const mcaps = data.market_caps ? data.market_caps.map(m => m[1]) : [];

    const pCtx = document.getElementById('priceChart')?.getContext('2d');
    if (!pCtx) return;
    const grad = pCtx.createLinearGradient(0, 0, 0, 400);
    grad.addColorStop(0, 'rgba(247,147,26,0.3)');
    grad.addColorStop(1, 'rgba(247,147,26,0.0)');

    makeChart('priceChart', {
      type: 'line',
      data: { labels, datasets: [{ label: 'BTC Price', data: prices, borderColor: BTC_ORANGE, borderWidth: 1.5, backgroundColor: grad, fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 }] },
      options: {
        responsive: true, interaction: { mode: 'index', intersect: false },
        plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,16,0.95)', borderColor: 'rgba(247,147,26,0.3)', borderWidth: 1, titleColor: '#6b5c42', bodyColor: '#f7931a', callbacks: { label: c => fmt.price(c.parsed.y) } } },
        scales: { x: { ticks: { maxTicksLimit: 8 }, grid: { display: false } }, y: { ticks: { callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'k' : v) }, grid: { color: 'rgba(247,147,26,0.06)' } } }
      }
    });

    if (volumes.length) {
      makeChart('volumeChart', {
        type: 'bar',
        data: { labels: labels.filter((_,i) => i % Math.max(1, Math.floor(labels.length/30)) === 0), datasets: [{ label: 'Volume', data: volumes.filter((_,i) => i % Math.max(1, Math.floor(volumes.length/30)) === 0), backgroundColor: 'rgba(247,147,26,0.3)', borderColor: 'rgba(247,147,26,0.6)', borderWidth: 1 }] },
        options: { responsive: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => fmt.compact(c.parsed.y) } } }, scales: { x: { ticks: { maxTicksLimit: 6 } }, y: { ticks: { callback: v => fmt.compact(v).replace('$','') } } } }
      });
    }

    if (mcaps.length) {
      const mcCtx = document.getElementById('mcapChart')?.getContext('2d');
      if (mcCtx) {
        const mcGrad = mcCtx.createLinearGradient(0, 0, 0, 300);
        mcGrad.addColorStop(0, 'rgba(0,255,136,0.2)');
        mcGrad.addColorStop(1, 'rgba(0,255,136,0.0)');
        makeChart('mcapChart', {
          type: 'line',
          data: { labels: labels.filter((_,i) => i % Math.max(1, Math.floor(labels.length/30)) === 0), datasets: [{ label: 'Market Cap', data: mcaps.filter((_,i) => i % Math.max(1, Math.floor(mcaps.length/30)) === 0), borderColor: GREEN, borderWidth: 1.5, backgroundColor: mcGrad, fill: true, tension: 0.3, pointRadius: 0 }] },
          options: { responsive: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => fmt.compact(c.parsed.y) } } }, scales: { x: { ticks: { maxTicksLimit: 6 }, grid: { display: false } }, y: { ticks: { callback: v => '$' + (v/1e9).toFixed(0) + 'B' } } } }
        });
      }
    }

    buildAdvancedCharts(prices, labels);
}

function buildAdvancedCharts(prices, labels) {
  // OHLC simulation (using actual daily price segments)
  const step = Math.max(1, Math.floor(prices.length / 14));
  const ohlcLabels = [], opens = [], highs = [], lows = [], closes = [];
  for (let i = 0; i < prices.length - step; i += step) {
    const seg = prices.slice(i, i + step);
    opens.push(seg[0]);
    closes.push(seg[seg.length - 1]);
    highs.push(Math.max(...seg));
    lows.push(Math.min(...seg));
    ohlcLabels.push(labels[i]);
  }
  if (ohlcLabels.length > 0) {
    const colors = closes.map((c, i) => c >= opens[i] ? 'rgba(0,255,136,0.7)' : 'rgba(255,51,102,0.7)');
    const borderColors = closes.map((c, i) => c >= opens[i] ? GREEN : RED);
    makeChart('ohlcChart', {
      type: 'bar',
      data: {
        labels: ohlcLabels,
        datasets: [
          { label: 'Low', data: lows, backgroundColor: 'transparent', borderColor: 'transparent', stack: 'ohlc' },
          {
            label: 'Range', data: closes.map((c,i) => Math.abs(c - opens[i])),
            backgroundColor: colors, borderColor: borderColors, borderWidth: 1, stack: 'ohlc',
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: {
          callbacks: {
            label: (c) => {
              const i = c.dataIndex;
              return [`O: ${fmt.price(opens[i])}`, `H: ${fmt.price(highs[i])}`, `L: ${fmt.price(lows[i])}`, `C: ${fmt.price(closes[i])}`];
            }
          }
        }},
        scales: {
          x: { stacked: true, ticks: { maxTicksLimit: 7 }, grid: { display: false } },
          y: { stacked: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } }
        }
      }
    });
  }

  // Moving Averages
  if (prices.length >= 20) {
    const maLabels = labels.slice(19);
    const ma7 = [], ma20 = [];
    for (let i = 19; i < prices.length; i++) {
      ma7.push(prices.slice(Math.max(0,i-6), i+1).reduce((a,b)=>a+b)/Math.min(7,i+1));
      ma20.push(prices.slice(i-19, i+1).reduce((a,b)=>a+b)/20);
    }
    const maCtx = document.getElementById('maChart')?.getContext('2d');
    if (maCtx) {
      const maGrad = maCtx.createLinearGradient(0,0,0,300);
      maGrad.addColorStop(0,'rgba(247,147,26,0.15)');
      maGrad.addColorStop(1,'rgba(247,147,26,0)');
      makeChart('maChart', {
        type: 'line',
        data: {
          labels: maLabels.filter((_,i) => i % Math.max(1,Math.floor(maLabels.length/20))===0),
          datasets: [
            {
              label: 'Price', data: prices.slice(19).filter((_,i) => i % Math.max(1,Math.floor(maLabels.length/20))===0),
              borderColor: 'rgba(247,147,26,0.4)', borderWidth: 1, pointRadius: 0, tension: 0.3,
              backgroundColor: maGrad, fill: true
            },
            {
              label: 'MA7', data: ma7.filter((_,i) => i % Math.max(1,Math.floor(maLabels.length/20))===0),
              borderColor: GREEN, borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false
            },
            {
              label: 'MA20', data: ma20.filter((_,i) => i % Math.max(1,Math.floor(maLabels.length/20))===0),
              borderColor: RED, borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true, labels: { boxWidth: 10, color: '#6b5c42' } } },
          scales: { x: { ticks: { maxTicksLimit: 6 }, grid: { display: false } }, y: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } }
        }
      });
    }
  }

  // RSI (14-period)
  if (prices.length >= 15) {
    const rsiVals = [], rsiLabels = [];
    for (let i = 14; i < prices.length; i++) {
      const changes = prices.slice(i-14, i+1).map((v,j,a) => j > 0 ? v - a[j-1] : 0).slice(1);
      const gains = changes.filter(c => c > 0);
      const losses = changes.filter(c => c < 0).map(Math.abs);
      const avgGain = gains.reduce((a,b)=>a+b,0) / 14;
      const avgLoss = losses.reduce((a,b)=>a+b,0) / 14;
      const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
      rsiVals.push(100 - (100 / (1 + rs)));
      rsiLabels.push(labels[i]);
    }
    const filtered = rsiVals.filter((_,i)=>i%Math.max(1,Math.floor(rsiVals.length/30))===0);
    const filtLabels = rsiLabels.filter((_,i)=>i%Math.max(1,Math.floor(rsiLabels.length/30))===0);
    makeChart('rsiChart', {
      type: 'line',
      data: {
        labels: filtLabels,
        datasets: [
          {
            label: 'RSI', data: filtered,
            borderColor: BTC_ORANGE, borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false
          },
          { label: 'Overbought', data: Array(filtered.length).fill(70), borderColor: RED, borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: false },
          { label: 'Oversold', data: Array(filtered.length).fill(30), borderColor: GREEN, borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: false },
          { label: 'Mid', data: Array(filtered.length).fill(50), borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, pointRadius: 0, fill: false },
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxTicksLimit: 6 }, grid: { display: false } },
          y: { min: 0, max: 100, ticks: { callback: v => v } }
        }
      }
    });
  }

  // Bollinger Bands (20-period)
  if (prices.length >= 20) {
    const bbLabels = [], upper = [], lower = [], mid = [], priceSlice = [];
    for (let i = 19; i < prices.length; i++) {
      const seg = prices.slice(i-19, i+1);
      const avg = seg.reduce((a,b)=>a+b)/20;
      const std = Math.sqrt(seg.reduce((s,v)=>s+(v-avg)**2,0)/20);
      mid.push(avg); upper.push(avg + 2*std); lower.push(avg - 2*std);
      priceSlice.push(prices[i]); bbLabels.push(labels[i]);
    }
    const step2 = Math.max(1, Math.floor(bbLabels.length/25));
    const sliced = (arr) => arr.filter((_,i)=>i%step2===0);
    const bbCtx = document.getElementById('bollingerChart')?.getContext('2d');
    if (bbCtx) {
      const uGrad = bbCtx.createLinearGradient(0,0,0,200);
      uGrad.addColorStop(0,'rgba(247,147,26,0.08)');
      uGrad.addColorStop(1,'rgba(247,147,26,0.0)');
      makeChart('bollingerChart', {
        type: 'line',
        data: {
          labels: sliced(bbLabels),
          datasets: [
            { label: 'Upper', data: sliced(upper), borderColor: 'rgba(247,147,26,0.4)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3 },
            { label: 'Mid', data: sliced(mid), borderColor: 'rgba(247,147,26,0.8)', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 },
            { label: 'Lower', data: sliced(lower), borderColor: 'rgba(247,147,26,0.4)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: uGrad, tension: 0.3 },
            { label: 'Price', data: sliced(priceSlice), borderColor: 'rgba(255,255,255,0.5)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3 },
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { maxTicksLimit: 6 }, grid: { display: false } },
            y: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } }
          }
        }
      });
    }
  }

  // Daily Returns Distribution
  if (prices.length >= 7) {
    const dailyReturns = prices.slice(1).map((v,i) => ((v - prices[i]) / prices[i]) * 100);
    const bins = Array.from({length:20}, (_,i) => -10 + i * 1);
    const hist = Array(20).fill(0);
    dailyReturns.forEach(r => {
      const idx = Math.min(19, Math.max(0, Math.floor((r + 10))));
      hist[idx]++;
    });
    makeChart('returnsChart', {
      type: 'bar',
      data: {
        labels: bins.map(b => b.toFixed(0) + '%'),
        datasets: [{
          label: 'Frequency',
          data: hist,
          backgroundColor: bins.map(b => b < 0 ? 'rgba(255,51,102,0.5)' : 'rgba(0,255,136,0.5)'),
          borderColor: bins.map(b => b < 0 ? RED : GREEN),
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.parsed.y + ' periods' } } },
        scales: { x: { ticks: { maxTicksLimit: 8 } }, y: { ticks: { stepSize: 1 } } }
      }
    });
  }
}

// ═══════════════════════════════════════
// GLOBAL TABLE
// ═══════════════════════════════════════
function buildGlobalTable(coins) {
  const tbody = document.getElementById('global-tbody');
  if (!tbody) return;

  // Calculate total market cap for dominance
  const totalMcap = coins.reduce((s,c) => s + (c.market_cap || 0), 0);

  tbody.innerHTML = coins.map((c, i) => {
    const ch24 = c.price_change_percentage_24h;
    const ch7 = c.price_change_percentage_7d_in_currency;
    const dom = totalMcap > 0 ? ((c.market_cap / totalMcap) * 100).toFixed(1) + '%' : '—';
    const chStyle = (v) => v == null ? '' : `style="color:${v >= 0 ? 'var(--green)' : 'var(--red)'}"`;
    return `<tr>
      <td style="color:var(--dim)">${i+1}</td>
      <td style="color:var(--btc);font-family:'Orbitron';font-size:10px;">${c.symbol?.toUpperCase()}</td>
      <td>${fmt.price(c.current_price)}</td>
      <td ${chStyle(ch24)}>${fmt.pct(ch24)}</td>
      <td ${chStyle(ch7)}>${fmt.pct(ch7)}</td>
      <td>${fmt.compact(c.market_cap)}</td>
      <td>${fmt.compact(c.total_volume)}</td>
      <td style="color:var(--dim)">${dom}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════
// DOMINANCE PIE
// ═══════════════════════════════════════
function buildDominanceChart(coins) {
  const top5 = coins.slice(0,5);
  const totalMcap = coins.reduce((s,c) => s + (c.market_cap||0), 0);
  const data = top5.map(c => (c.market_cap / totalMcap * 100).toFixed(1));
  const labels = top5.map(c => c.symbol?.toUpperCase());
  makeChart('dominanceChart', {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: ['rgba(247,147,26,0.85)','rgba(0,255,136,0.6)','rgba(100,180,255,0.6)','rgba(255,51,102,0.6)','rgba(180,100,255,0.6)'],
        borderColor: 'rgba(0,0,0,0.5)',
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      cutout: '60%',
      plugins: {
        legend: { display: true, position: 'bottom', labels: { boxWidth: 8, padding: 8, color: '#6b5c42', font: { size: 9 } } },
        tooltip: { callbacks: { label: c => c.label + ': ' + c.parsed.toFixed(1) + '%' } }
      }
    }
  });
}

// ═══════════════════════════════════════
// EXCHANGE VOLUME (mock top exchanges)
// ═══════════════════════════════════════
function buildExchangeVolume(coins) {
  const btc = coins[0];
  if (!btc) return;
  const totalVol = btc.total_volume;
  const exchanges = [
    { name: 'Binance', pct: 0.31 },
    { name: 'Coinbase', pct: 0.18 },
    { name: 'Kraken', pct: 0.12 },
    { name: 'Bybit', pct: 0.10 },
    { name: 'OKX', pct: 0.09 },
    { name: 'Others', pct: 0.20 },
  ];
  const maxVol = totalVol * 0.31;
  const html = exchanges.map(e => `
    <div class="exchange-row">
      <span class="ex-name">${e.name}</span>
      <div class="ex-bar"><div class="ex-bar-fill" style="width:${(e.pct/0.31*100).toFixed(0)}%"></div></div>
      <span class="ex-vol">${fmt.compact(totalVol * e.pct)}</span>
    </div>
  `).join('');
  document.getElementById('exchange-vol-content').innerHTML = html;
}

// ═══════════════════════════════════════
// FEAR & GREED
// ═══════════════════════════════════════
async function fetchFearGreed() {
  try {
    const res = await fetch('https://api.alternative.me/fng/?limit=1');
    const { data } = await res.json();
    if (!data || !data[0]) return;
    const val = parseInt(data[0].value);
    const label = data[0].value_classification;
    setText('fg-value', val);
    setText('fg-label', label.toUpperCase());
    const fgVal = document.getElementById('fg-value');
    const fgBar = document.getElementById('fg-bar');
    if (fgVal) {
      if (val <= 25) { fgVal.style.color = 'var(--red)'; fgBar.style.background = 'var(--red)'; }
      else if (val <= 45) { fgVal.style.color = 'rgb(255,120,0)'; fgBar.style.background = 'rgb(255,120,0)'; }
      else if (val <= 55) { fgVal.style.color = 'var(--text)'; fgBar.style.background = 'var(--text)'; }
      else if (val <= 75) { fgVal.style.color = 'var(--btc)'; fgBar.style.background = 'var(--btc)'; }
      else { fgVal.style.color = 'var(--green)'; fgBar.style.background = 'var(--green)'; }
    }
    if (fgBar) fgBar.style.width = val + '%';
  } catch(e) {}
}

// ═══════════════════════════════════════
// MEMPOOL.SPACE
// ═══════════════════════════════════════
async function fetchMempool() {
  try {
    const [feeRes, mempoolRes, blockRes] = await Promise.all([
      fetch('https://mempool.space/api/v1/fees/recommended'),
      fetch('https://mempool.space/api/mempool'),
      fetch('https://mempool.space/api/v1/blocks/tip/height'),
    ]);

    const fees = await feeRes.json();
    const mempool = await mempoolRes.json();
    const blockHeight = await blockRes.json();

    // Fees display
    document.getElementById('mempool-content').innerHTML = `
      <div class="mempool-row">
        <span style="font-size:11px;color:var(--dim);">⚡ FASTEST</span>
        <span class="fee-badge fee-fast">${fees.fastestFee} sat/vB</span>
        <span style="font-size:10px;color:var(--dim);">~10 min</span>
      </div>
      <div class="mempool-row">
        <span style="font-size:11px;color:var(--dim);">🟠 MEDIUM</span>
        <span class="fee-badge fee-med">${fees.halfHourFee} sat/vB</span>
        <span style="font-size:10px;color:var(--dim);">~30 min</span>
      </div>
      <div class="mempool-row">
        <span style="font-size:11px;color:var(--dim);">🟢 ECONOMY</span>
        <span class="fee-badge fee-slow">${fees.hourFee} sat/vB</span>
        <span style="font-size:10px;color:var(--dim);">~60 min</span>
      </div>
      <div class="mempool-row">
        <span style="font-size:11px;color:var(--dim);">MINIMUM</span>
        <span style="font-size:12px;color:var(--dim);">${fees.minimumFee} sat/vB</span>
      </div>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(247,147,26,0.1);">
        <div style="font-size:10px;color:var(--dim);margin-bottom:6px;">MEMPOOL STATUS</div>
        <div style="font-size:12px;margin-bottom:4px;">PENDING TXS: <span style="color:var(--btc)">${fmt.number(mempool.count)}</span></div>
        <div style="font-size:12px;margin-bottom:4px;">SIZE: <span style="color:var(--btc)">${(mempool.vsize/1e6).toFixed(2)} MB</span></div>
        <div style="font-size:12px;">TOTAL FEES: <span style="color:var(--btc)">${(mempool.total_fee/1e8).toFixed(4)} BTC</span></div>
      </div>
    `;

    // Block height for ticker + halving
    const height = blockHeight;
    ['t-block','t-block2'].forEach(id => setText(id, '#' + fmt.number(height)));
    ['t-mempool','t-mempool2'].forEach(id => setText(id, fmt.number(mempool.count)));

    // Halving
    const NEXT_HALVING = 1050000;
    const blocksLeft = NEXT_HALVING - height;
    const secsLeft = blocksLeft * 10 * 60;
    const halvingDate = new Date(Date.now() + secsLeft * 1000);
    setText('halving-block', '#' + fmt.number(NEXT_HALVING));
    setText('halving-blocks-left', fmt.number(blocksLeft));
    setText('halving-date', halvingDate.toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}));
    ['t-halving','t-halving2'].forEach(id => setText(id, halvingDate.toLocaleDateString()));

    // Countdown
    function updateCountdown() {
      const now = new Date();
      const diff = halvingDate - now;
      if (diff <= 0) { setText('hc-days','0'); setText('hc-hours','0'); setText('hc-mins','0'); setText('hc-secs','0'); return; }
      const d = Math.floor(diff / 86400000);
      const h = Math.floor((diff % 86400000) / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      setText('hc-days', d); setText('hc-hours', h); setText('hc-mins', m); setText('hc-secs', s);
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);

  } catch(e) { console.error('Mempool error:', e); }
}

// ═══════════════════════════════════════
// RECENT BLOCKS
// ═══════════════════════════════════════
async function fetchBlocks() {
  try {
    const res = await fetch('https://mempool.space/api/v1/blocks');
    const blocks = await res.json();
    if (!blocks || !blocks.length) return;
    const row = document.getElementById('blocks-row');
    if (!row) return;
    row.innerHTML = blocks.slice(0,12).map(b => `
      <div class="block-card" onclick="window.open('https://mempool.space/block/${b.id}','_blank')">
        <div class="b-height">${fmt.number(b.height)}</div>
        <div class="b-txs">${fmt.number(b.tx_count)} txs</div>
        <div class="b-size">${(b.size/1e6).toFixed(2)}MB</div>
        <div class="b-txs">${(b.extras?.totalFees/1e8||0).toFixed(4)}₿</div>
      </div>
    `).join('');
  } catch(e) { console.error('Blocks error:', e); }
}

// ═══════════════════════════════════════
// INIT & REFRESH
// Stagger CoinGecko calls so they don't all fire simultaneously
// CG queue enforces 2.5s gap — init takes ~7s total for 3 CG calls
// Mempool/F&G are different services, safe to fire immediately
// ═══════════════════════════════════════
async function init() {
  // Non-CoinGecko calls fire instantly
  fetchFearGreed();
  fetchMempool();
  fetchBlocks();

  // CoinGecko calls are queued — fire sequentially with 2.5s spacing
  fetchCoinGeckoMarket();           // queued call 1
  fetchGlobal();                    // queued call 2 (fires ~2.5s later)
  loadPriceChart(7);                // queued call 3 (fires ~5s later)
}

init();

// Intervals — conservative to stay well under 30 req/min
// CoinGecko: 1 call per 90s = ~0.7 req/min
// Global merged into market cycle every 3rd tick
let marketCycle = 0;
setInterval(() => {
  fetchCoinGeckoMarket();
  if (++marketCycle % 3 === 0) fetchGlobal(); // global every 270s
}, 90000);

setInterval(fetchFearGreed, 300000);  // 5 min — alternative.me
setInterval(fetchMempool, 60000);     // 60s  — mempool.space (generous limit)
setInterval(fetchBlocks, 120000);     // 2 min — mempool.space
</script>
</body>
</html>
